name: Build FlowPOS Pro Windows

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Install Electron dependencies
        run: npm install --save-dev electron@28.0.0 electron-builder@24.9.1

      - name: Build web application
        run: npm run build

      - name: Create Electron Builder config
        shell: bash
        run: |
          cat > electron-builder.json << 'EOF'
          {
            "appId": "app.flowpos.pro",
            "productName": "FlowPOS Pro",
            "directories": {
              "output": "electron-dist"
            },
            "files": [
              "dist/**/*",
              "electron/**/*",
              "resources/**/*"
            ],
            "extraResources": [
              {
                "from": "dist",
                "to": "dist",
                "filter": ["**/*"]
              }
            ],
            "win": {
              "target": [
                {
                  "target": "nsis",
                  "arch": ["x64"]
                }
              ],
              "icon": "resources/icon.png",
              "artifactName": "FlowPOS-Pro-Setup-${version}.exe"
            },
            "nsis": {
              "oneClick": false,
              "allowToChangeInstallationDirectory": true,
              "createDesktopShortcut": true,
              "createStartMenuShortcut": true,
              "shortcutName": "FlowPOS Pro"
            }
          }
          EOF

      - name: Update package.json for Electron
        shell: bash
        run: |
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.main = 'electron/main.js';
            pkg.version = '1.0.${{ github.run_number }}';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
          "

      - name: Build Windows Installer
        run: npx electron-builder --win --config electron-builder.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: FlowPOS-Pro-Windows-v1.0.${{ github.run_number }}
          path: electron-dist/*.exe
          retention-days: 30

      - name: Build Summary
        run: |
          echo "## FlowPOS Pro Windows Build Complete! :rocket:" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $env:GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $env:GITHUB_STEP_SUMMARY
          echo "| Version | 1.0.${{ github.run_number }} |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Platform | Windows x64 |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Output | FlowPOS-Pro-Setup-1.0.${{ github.run_number }}.exe |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Build Time | $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') |" >> $env:GITHUB_STEP_SUMMARY
