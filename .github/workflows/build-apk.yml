name: Build FlowPOS Pro APK

on:
  push:
    tags:
      - 'v*'
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    # 1. Java Ø£ÙˆÙ„Ø§Ù‹ (JDK 21 Ù…Ø·Ù„ÙˆØ¨ Ù„Ù€ Capacitor 8)
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'

    # 2. Setup Gradle (ÙŠØ­Ù„ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ÙƒØ§Ø´ ÙˆØ§Ù„ØªÙˆØ§ÙÙ‚)
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        gradle-version: '8.14.3'

    # 3. Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22
        cache: 'npm'

    # 4. Update Version FIRST (before cap add android)
    - name: Update Version Code
      run: |
        VERSION_CODE=${{ github.run_number }}
        VERSION_NAME="1.0.${VERSION_CODE}"
        echo "{\"versionCode\": ${VERSION_CODE}, \"versionName\": \"${VERSION_NAME}\"}" > version.json
        echo "VERSION_CODE=${VERSION_CODE}" >> $GITHUB_ENV
        echo "VERSION_NAME=${VERSION_NAME}" >> $GITHUB_ENV
        echo "âœ… Version: ${VERSION_NAME} (code: ${VERSION_CODE})"

    - name: Install dependencies
      run: npm ci --legacy-peer-deps
    
    - name: Build web app
      run: npm run build
    
    - name: Install Capacitor packages
      run: |
        npm install @capacitor/cli@latest @capacitor/android@latest @capacitor/assets@latest --save-dev --legacy-peer-deps
        
    # 5. ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ + Ø¥Ø¶Ø§ÙØ© Ø£Ø°ÙˆÙ†Ø§Øª
    - name: Initialize Capacitor & Permissions
      run: |
        rm -rf android
        
        cat > capacitor.config.json << 'EOF'
        {
          "appId": "com.flowpos.pro",
          "appName": "FlowPOS Pro",
          "webDir": "dist",
          "server": { "androidScheme": "https" },
          "plugins": {
            "Camera": { "cameraPermission": "Ù„Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙˆØªØµÙˆÙŠØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª" },
            "BarcodeScanner": { 
              "cameraPermissionText": "Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø·Ù„ÙˆØ¨ Ù„Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯",
              "formats": "ALL",
              "lensFacing": "BACK"
            },
            "Filesystem": { "androidExternalStorage": true }
          }
        }
        EOF
        
        npx cap add android
        
        # ØªØ­Ø¯ÙŠØ« Gradle wrapper Ø¥Ù„Ù‰ 8.14.3 (Ù…Ø·Ù„ÙˆØ¨ Ù„Ù€ AGP 8.13.0)
        cat > android/gradle/wrapper/gradle-wrapper.properties << 'EOF'
        distributionBase=GRADLE_USER_HOME
        distributionPath=wrapper/dists
        distributionUrl=https\://services.gradle.org/distributions/gradle-8.14.3-all.zip
        networkTimeout=10000
        validateDistributionUrl=true
        zipStoreBase=GRADLE_USER_HOME
        zipStorePath=wrapper/dists
        EOF
        
        # ØªØ­Ø¯ÙŠØ« variables.gradle Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Capacitor 8
        cat > android/variables.gradle << 'EOF'
        ext {
            minSdkVersion = 26
            compileSdkVersion = 36
            targetSdkVersion = 36
            androidxActivityVersion = '1.11.0'
            androidxAppCompatVersion = '1.7.1'
            androidxCoordinatorLayoutVersion = '1.3.0'
            androidxCoreVersion = '1.17.0'
            androidxFragmentVersion = '1.8.9'
            coreSplashScreenVersion = '1.2.0'
            androidxWebkitVersion = '1.14.0'
            junitVersion = '4.13.2'
            androidxJunitVersion = '1.3.0'
            androidxEspressoCoreVersion = '3.7.0'
            cordovaAndroidVersion = '14.0.1'
        }
        EOF
        
        # âœ… ÙƒØªØ§Ø¨Ø© build.gradle ÙƒØ§Ù…Ù„Ø§Ù‹ Ù…Ø¹ signingConfigs Ù…Ø¯Ù…Ø¬ (Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† sed Ø§Ù„Ø®Ø·ÙŠØ±)
        cat > android/app/build.gradle << GRADLE
        apply plugin: 'com.android.application'

        android {
            namespace = "com.flowpos.pro"
            compileSdk = rootProject.ext.compileSdkVersion
            defaultConfig {
                applicationId "com.flowpos.pro"
                minSdkVersion rootProject.ext.minSdkVersion
                targetSdkVersion rootProject.ext.targetSdkVersion
                
                versionCode ${VERSION_CODE}
                versionName "${VERSION_NAME}"
                
                testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
                aaptOptions {
                    ignoreAssetsPattern = '!.svn:!.git:!.ds_store:!*.scc:.*:!CVS:!thumbs.db:!picasa.ini:!*~'
                }
            }
            
            signingConfigs {
                release {
                    storeFile file("flowpos-release.keystore")
                    storePassword System.getenv("KEYSTORE_PASSWORD") ?: ""
                    keyAlias System.getenv("KEY_ALIAS") ?: ""
                    keyPassword System.getenv("KEY_PASSWORD") ?: ""
                }
            }
            
            buildTypes {
                release {
                    signingConfig signingConfigs.release
                    minifyEnabled false
                    proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
                }
            }
        }

        repositories {
            flatDir{
                dirs '../capacitor-cordova-android-plugins/src/main/libs', 'libs'
            }
        }

        dependencies {
            implementation fileTree(include: ['*.jar'], dir: 'libs')
            implementation "androidx.appcompat:appcompat:$androidxAppCompatVersion"
            implementation "androidx.coordinatorlayout:coordinatorlayout:$androidxCoordinatorLayoutVersion"
            implementation "androidx.core:core-splashscreen:$coreSplashScreenVersion"
            implementation project(':capacitor-android')
            testImplementation "junit:junit:$junitVersion"
            androidTestImplementation "androidx.test.ext:junit:$androidxJunitVersion"
            androidTestImplementation "androidx.test.espresso:espresso-core:$androidxEspressoCoreVersion"
            implementation project(':capacitor-cordova-android-plugins')
        }

        apply from: 'capacitor.build.gradle'

        try {
            def servicesJSON = file('google-services.json')
            if (servicesJSON.text) {
                apply plugin: 'com.google.gms.google-services'
            }
        } catch(Exception e) {
            logger.info("google-services.json not found, google-services plugin not applied. Push Notifications won't work")
        }
        GRADLE
        
        # Ø­Ù‚Ù† Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª ÙÙŠ AndroidManifest.xml
        PERMISSIONS='<uses-permission android:name="android.permission.CAMERA" />\n'
        PERMISSIONS+='    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />\n'
        PERMISSIONS+='    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />\n'
        PERMISSIONS+='    <uses-permission android:name="android.permission.INTERNET" />\n'
        PERMISSIONS+='    <uses-permission android:name="android.permission.VIBRATE" />\n'
        PERMISSIONS+='    <uses-feature android:name="android.hardware.camera" android:required="false" />\n'
        PERMISSIONS+='    <uses-feature android:name="android.hardware.camera.autofocus" android:required="false" />\n'
        PERMISSIONS+='    \n'
        PERMISSIONS+='    <!-- Queries for Android 11+ Share Intent -->\n'
        PERMISSIONS+='    <queries>\n'
        PERMISSIONS+='        <package android:name="com.whatsapp" />\n'
        PERMISSIONS+='        <package android:name="com.whatsapp.w4b" />\n'
        PERMISSIONS+='        <intent>\n'
        PERMISSIONS+='            <action android:name="android.intent.action.SEND" />\n'
        PERMISSIONS+='            <data android:mimeType="text/plain" />\n'
        PERMISSIONS+='        </intent>\n'
        PERMISSIONS+='        <intent>\n'
        PERMISSIONS+='            <action android:name="android.intent.action.VIEW" />\n'
        PERMISSIONS+='            <category android:name="android.intent.category.BROWSABLE" />\n'
        PERMISSIONS+='            <data android:scheme="https" />\n'
        PERMISSIONS+='        </intent>\n'
        PERMISSIONS+='    </queries>\n'
        PERMISSIONS+='    \n'
        PERMISSIONS+='    <application'
        
        MANIFEST="android/app/src/main/AndroidManifest.xml"
        sed -i "s|<application|$PERMISSIONS|" "$MANIFEST"
        
        echo "âœ… Permissions, Share queries, and signingConfigs written successfully"

    - name: Generate Assets & Sync
      run: |
        npx capacitor-assets generate --android --iconBackgroundColor "#1e40af" --assetPath resources
        npx cap sync android
    
    - name: Check for Keystore
      id: keystore_check
      run: |
        if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
          echo "has_keystore=true" >> $GITHUB_OUTPUT
        else
          echo "has_keystore=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Decode Keystore
      if: steps.keystore_check.outputs.has_keystore == 'true'
      run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/flowpos-release.keystore

    - name: Build Signed Release APK
      if: steps.keystore_check.outputs.has_keystore == 'true'
      env:
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        cd android
        chmod +x gradlew
        ./gradlew assembleRelease

    - name: Build Debug APK
      if: steps.keystore_check.outputs.has_keystore != 'true'
      run: cd android && chmod +x gradlew && ./gradlew assembleDebug

    - name: Create GitHub Release
      if: steps.keystore_check.outputs.has_keystore == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ env.VERSION_NAME }}
        name: FlowPOS Pro v${{ env.VERSION_NAME }}
        files: android/app/build/outputs/apk/release/app-release.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: FlowPOS-Pro-APK-v${{ env.VERSION_NAME }}
        path: android/app/build/outputs/apk/**/*.apk
        retention-days: 30

    - name: Build Summary
      run: |
        echo "## ðŸš€ FlowPOS Build Result" >> $GITHUB_STEP_SUMMARY
        echo "| Type | Status | Version |" >> $GITHUB_STEP_SUMMARY
        echo "| :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
        echo "| **Result** | âœ… Success | v${{ env.VERSION_NAME }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Version Code** | ${{ env.VERSION_CODE }} | For upgrade compatibility |" >> $GITHUB_STEP_SUMMARY
        echo "| **Java** | JDK 21 | Capacitor 8 |" >> $GITHUB_STEP_SUMMARY
        echo "| **Gradle** | 8.14.3 | AGP 8.13.0 |" >> $GITHUB_STEP_SUMMARY
        echo "| **Signing** | Full build.gradle rewrite | Consistent identity |" >> $GITHUB_STEP_SUMMARY
        echo "- **Permissions Added:** Camera, Storage (Read/Write), Internet, Vibrate" >> $GITHUB_STEP_SUMMARY
