name: Build FlowPOS Pro APK

on:
  push:
    tags:
      - 'v*'           # ÙŠØ¹Ù…Ù„ Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ ØªØ§Ø¬ (v1.0.0) Ù„Ø¥ØµØ¯Ø§Ø± Ù†Ø³Ø®Ø© Ø±Ø³Ù…ÙŠØ©
    branches: [ main ] # ÙŠØ¹Ù…Ù„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ù„ÙƒÙˆØ¯
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    # ØªØ­Ø³ÙŠÙ† 1: Ø¥Ø¹Ø¯Ø§Ø¯ Java Ù…Ø¹ ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒØ§Ø´ Ù„ØªØ³Ø±ÙŠØ¹ Ø¨Ù†Ø§Ø¡ Gradle
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle' # âš¡ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ø³ÙŠÙˆÙØ± Ø§Ù„ÙƒØ«ÙŠØ± Ù…Ù† Ø§Ù„ÙˆÙ‚Øª ÙÙŠ Ø§Ù„Ù…Ø±Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci

    # ØªØ­Ø³ÙŠÙ† 2: Ø®Ø·ÙˆØ© Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¬ÙˆØ¯Ø© Ø§Ù„ÙƒÙˆØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡
    # - name: Run Linter & Tests
    #   run: |
    #     npm run lint
    #     npm test

    - name: Build web app
      run: npm run build
    
    - name: Install Capacitor packages
      run: |
        npm install @capacitor/cli@6 @capacitor/core@6 @capacitor/android@6 @capacitor/assets --save-dev
        npm install @capacitor-mlkit/barcode-scanning@6
        
    - name: Initialize Capacitor & Permissions
      # Ù‚Ù…Øª Ø¨Ø¯Ù…Ø¬ Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙÙˆØ¶Ù‰
      run: |
        rm -rf android
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„ÙƒÙˆÙ†ÙÙŠØ¬
        cat > capacitor.config.json << 'EOF'
        {
          "appId": "com.flowpos.pro",
          "appName": "FlowPOS Pro",
          "webDir": "dist",
          "server": { "androidScheme": "https" },
          "plugins": {
            "Camera": { "cameraPermission": "Ù„Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙˆØªØµÙˆÙŠØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª" },
            "BarcodeScanner": { "cameraPermissionText": "Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø·Ù„ÙˆØ¨" }
          }
        }
        EOF
        
        npx cap add android
        
        # ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø§Ù†ÙŠÙÙŠØ³Øª
        MANIFEST="android/app/src/main/AndroidManifest.xml"
        sed -i 's/<application/<uses-permission android:name="android.permission.CAMERA" \/>\n    <application/' "$MANIFEST"
        
    - name: Generate Assets & Sync
      run: |
        npx capacitor-assets generate --android --iconBackgroundColor "#1e40af"
        npx cap sync android
    
    - name: Update Version Code
      run: |
        VERSION_CODE=${{ github.run_number }}
        # ØªØ¹Ø¯ÙŠÙ„ build.gradle Ù„Ø²ÙŠØ§Ø¯Ø© Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        sed -i "s/versionCode 1/versionCode $VERSION_CODE/" android/app/build.gradle
        sed -i 's/versionName "1.0"/versionName "1.0.'$VERSION_CODE'"/' android/app/build.gradle

    # ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹
    - name: Check for Keystore
      id: keystore_check
      run: |
        if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
          echo "has_keystore=true" >> $GITHUB_OUTPUT
        else
          echo "has_keystore=false" >> $GITHUB_OUTPUT
        fi
    
    # ÙÙƒ ØªØ´ÙÙŠØ± Ø§Ù„Ù…ÙØªØ§Ø­ (ÙÙ‚Ø· Ø¥Ø°Ø§ ÙˆØ¬Ø¯)
    - name: Decode Keystore
      if: steps.keystore_check.outputs.has_keystore == 'true'
      run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/flowpos-release.keystore

    # Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹Ø© (Release)
    - name: Build Signed Release APK
      if: steps.keystore_check.outputs.has_keystore == 'true'
      run: |
        cd android
        chmod +x gradlew
        ./gradlew assembleRelease \
          -Pandroid.injected.signing.store.file=$PWD/app/flowpos-release.keystore \
          -Pandroid.injected.signing.store.password=${{ secrets.KEYSTORE_PASSWORD }} \
          -Pandroid.injected.signing.key.alias=${{ secrets.KEY_ALIAS }} \
          -Pandroid.injected.signing.key.password=${{ secrets.KEY_PASSWORD }}

    # Ø¨Ù†Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ù„ØªØ¬Ø±Ø¨Ø© (Debug) Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ù…ÙØªØ§Ø­
    - name: Build Debug APK
      if: steps.keystore_check.outputs.has_keystore != 'true'
      run: cd android && chmod +x gradlew && ./gradlew assembleDebug

    # ØªØ­Ø³ÙŠÙ† 3: Ø¥Ù†Ø´Ø§Ø¡ GitHub Release Ø±Ø³Ù…ÙŠ (ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…ÙØªØ§Ø­ ØªÙˆÙ‚ÙŠØ¹)
    - name: Create GitHub Release
      if: steps.keystore_check.outputs.has_keystore == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: Release v1.0.${{ github.run_number }}
        draft: false
        prerelease: false
        files: android/app/build/outputs/apk/release/app-release.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ÙƒÙ€ Artifacts (Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ Ø£Ùˆ Ù„Ù†Ø³Ø® Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬)
    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: FlowPOS-APK
        path: android/app/build/outputs/apk/**/*.apk
        retention-days: 14

    - name: Build Summary
      run: |
        echo "## ðŸš€ FlowPOS Build Result" >> $GITHUB_STEP_SUMMARY
        echo "| Type | Status | Version |" >> $GITHUB_STEP_SUMMARY
        echo "| :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
        echo "| **Result** | âœ… Success | v1.0.${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "â¬‡ï¸ **[ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù† Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})**" >> $GITHUB_STEP_SUMMARY
 
