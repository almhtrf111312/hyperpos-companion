name: Build FlowPOS Pro APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
    
    - name: Build web app
      run: npm run build
    
    - name: Install Capacitor packages
      run: |
        npm install @capacitor/cli@6 @capacitor/core@6 @capacitor/android@6 @capacitor/assets --save-dev
        # Install ML Kit Barcode Scanner for native camera permissions
        npm install @capacitor-mlkit/barcode-scanning@6
        
    - name: Initialize Capacitor
      run: |
        # Remove existing android folder if exists
        rm -rf android
        
        # Create capacitor config with BarcodeScanner permissions
        cat > capacitor.config.json << 'EOF'
        {
          "appId": "com.flowpos.pro",
          "appName": "FlowPOS Pro",
          "webDir": "dist",
          "server": {
            "androidScheme": "https"
          },
          "plugins": {
            "Camera": {
              "photoGalleryPermission": "Ù„Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª",
              "cameraPermission": "Ù„Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙˆØªØµÙˆÙŠØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª"
            },
            "BarcodeScanner": {
              "cameraPermissionText": "ÙŠØ­ØªØ§Ø¬ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯"
            },
            "Filesystem": {
              "androidExternalStorage": true
            }
          }
        }
        EOF
        
        # Add Android platform
        npx cap add android
        
    - name: Add Camera Permission to AndroidManifest
      run: |
        # Ensure camera permission is in AndroidManifest.xml
        MANIFEST="android/app/src/main/AndroidManifest.xml"
        
        # Check if CAMERA permission already exists
        if ! grep -q "android.permission.CAMERA" "$MANIFEST"; then
          # Add camera permission after the first <uses-permission> or before <application>
          sed -i 's/<application/<uses-permission android:name="android.permission.CAMERA" \/>\n    <application/' "$MANIFEST"
          echo "âœ… Added CAMERA permission to AndroidManifest.xml"
        else
          echo "âœ… CAMERA permission already exists"
        fi
        
        # Also ensure INTERNET permission exists
        if ! grep -q "android.permission.INTERNET" "$MANIFEST"; then
          sed -i 's/<application/<uses-permission android:name="android.permission.INTERNET" \/>\n    <application/' "$MANIFEST"
          echo "âœ… Added INTERNET permission"
        fi
        
        cat "$MANIFEST"
        
    - name: Generate App Icons
      run: |
        npx capacitor-assets generate --android --iconBackgroundColor "#1e40af"
        
    - name: Sync Capacitor
      run: npx cap sync android
    
    - name: Update Version Code
      run: |
        VERSION_CODE=${{ github.run_number }}
        sed -i "s/versionCode 1/versionCode $VERSION_CODE/" android/app/build.gradle
        sed -i 's/versionName "1.0"/versionName "1.0.'$VERSION_CODE'"/' android/app/build.gradle
        echo "âœ… Updated to versionCode: $VERSION_CODE, versionName: 1.0.$VERSION_CODE"
        
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Check for Keystore
      id: keystore_check
      run: |
        if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
          echo "has_keystore=true" >> $GITHUB_OUTPUT
        else
          echo "has_keystore=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Decode Keystore
      if: steps.keystore_check.outputs.has_keystore == 'true'
      run: |
        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/flowpos-release.keystore
        echo "âœ… Keystore decoded successfully"
        
    - name: Build Signed Release APK
      if: steps.keystore_check.outputs.has_keystore == 'true'
      run: |
        cd android
        chmod +x gradlew
        ./gradlew assembleRelease \
          -Pandroid.injected.signing.store.file=$PWD/app/flowpos-release.keystore \
          -Pandroid.injected.signing.store.password=${{ secrets.KEYSTORE_PASSWORD }} \
          -Pandroid.injected.signing.key.alias=${{ secrets.KEY_ALIAS }} \
          -Pandroid.injected.signing.key.password=${{ secrets.KEY_PASSWORD }}
        echo "âœ… Signed APK built successfully"
    
    - name: Build Debug APK
      if: steps.keystore_check.outputs.has_keystore != 'true'
      run: |
        cd android
        chmod +x gradlew
        ./gradlew assembleDebug
        echo "âœ… Debug APK built successfully"
        
    - name: Upload Signed APK
      if: steps.keystore_check.outputs.has_keystore == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: FlowPOS-Pro-v1.0.${{ github.run_number }}-release
        path: android/app/build/outputs/apk/release/app-release.apk
        retention-days: 30
        if-no-files-found: error
        
    - name: Upload Debug APK
      if: steps.keystore_check.outputs.has_keystore != 'true'
      uses: actions/upload-artifact@v4
      with:
        name: FlowPOS-Pro-v1.0.${{ github.run_number }}-debug
        path: android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
        if-no-files-found: error
        
    - name: Build Summary
      run: |
        echo "## ðŸ“± FlowPOS Pro APK Build Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Version:** 1.0.${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Type:** ${{ steps.keystore_check.outputs.has_keystore == 'true' && 'Release (Signed)' || 'Debug' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Camera Permission:** âœ… Included" >> $GITHUB_STEP_SUMMARY
