
# خطة تطوير واجهة عرض المخزون وخصم الوحدات الذكي

## ملخص المشروع
تحسين واجهة عرض المخزون لتظهر الكميات في خانتين منفصلتين واضحتين (عدد الكراتين الكاملة + القطع المتبقية)، مع إصلاح منطق الخصم عند البيع ليتعامل بشكل صحيح مع التحويل بين الوحدات.

---

## المتطلبات الوظيفية

### 1. واجهة العرض الثنائية (Dual-Unit Display)
- **خانة الكراتين**: تعرض عدد الكراتين الكاملة (مثال: 9 كرتونة)
- **خانة القطع**: تعرض عدد القطع المتبقية خارج الكرتونة (مثال: 17 قطعة)
- **المجموع**: يظهر تحتها بخط صغير إجمالي القطع (مثال: المجموع: 197 قطعة)

### 2. منطق الخصم عند البيع
- عند بيع قطعة واحدة → ينقص رقم القطع
- إذا وصل القطع إلى 0 وتم بيع قطعة → ينقص الكراتين بـ 1 وتصبح القطع = معامل التحويل - 1
- مثال: (10 كرتونة، 0 قطعة) → بيع قطعة → (9 كرتونة، 19 قطعة)

### 3. تطوير واجهة إدخال المخزون
- خانتين منفصلتين عند الإضافة/التعديل:
  - خانة "عدد الكراتين الكاملة"
  - خانة "القطع الزائدة"
- النظام يجمعهم تلقائياً ويخزنهم كقطع

---

## التغييرات التقنية

### المرحلة 1: إنشاء مكون عرض المخزون الثنائي
**ملف جديد**: `src/components/products/DualUnitDisplay.tsx`

```text
┌─────────────────────────────────────┐
│  ┌──────────┐   ┌──────────────┐    │
│  │ 9 كرتونة │   │ 17 قطعة     │    │
│  └──────────┘   └──────────────┘    │
│        المجموع: 197 قطعة           │
└─────────────────────────────────────┘
```

**الحسابات**:
- عدد الكراتين = `Math.floor(totalPieces / conversionFactor)`
- القطع المتبقية = `totalPieces % conversionFactor`

---

### المرحلة 2: تحديث جدول المنتجات
**ملف**: `src/pages/Products.tsx`

- استبدال عرض المخزون الحالي بالمكون الجديد `DualUnitDisplay`
- يظهر في عمود "المخزون" على شكل خانتين متجاورتين
- الحالة (متوفر/منخفض/نفد) تظهر أسفل الخانتين

---

### المرحلة 3: تحديث نقطة البيع (POS)
**ملف**: `src/components/pos/ProductGrid.tsx`

- إضافة عرض الوحدات الثنائي لكل منتج في الشبكة
- تحديث الواجهة لتظهر:
  - `[X كرتونة]` + `[Y قطعة]`
  - المجموع بخط صغير

---

### المرحلة 4: تطوير واجهة إدخال المخزون
**ملف**: `src/components/products/UnitSettingsTab.tsx` و `src/pages/Products.tsx`

**تصميم الإدخال الجديد**:
```text
┌────────────────────────────────────────────┐
│ الكمية الابتدائية:                         │
│ ┌─────────────────┐  ┌─────────────────┐   │
│ │ عدد الكراتين   │  │ القطع الزائدة  │   │
│ │      [10]       │  │      [5]        │   │
│ └─────────────────┘  └─────────────────┘   │
│ = 205 قطعة (10 × 20 + 5)                   │
└────────────────────────────────────────────┘
```

**المعادلة**:
```
إجمالي القطع = (عدد الكراتين × معامل التحويل) + القطع الزائدة
```

---

### المرحلة 5: التحقق من منطق الخصم
**الملفات**:
- `src/components/pos/CartPanel.tsx`
- `src/lib/cloud/products-cloud.ts`

المنطق الحالي يعمل بشكل صحيح لأن:
- الكمية تُخزن دائماً بالقطع في قاعدة البيانات
- عند البيع، يتم خصم عدد القطع مباشرة
- العرض فقط هو الذي يحتاج تحديث (تحويل القطع → كراتين + قطع)

---

## الملفات المتأثرة

| الملف | نوع التغيير |
|-------|-------------|
| `src/components/products/DualUnitDisplay.tsx` | جديد |
| `src/components/products/UnitSettingsTab.tsx` | تعديل |
| `src/pages/Products.tsx` | تعديل |
| `src/components/pos/ProductGrid.tsx` | تعديل |

---

## التفاصيل التقنية

### مكون DualUnitDisplay (المكون الجديد)
```typescript
interface DualUnitDisplayProps {
  totalPieces: number;           // إجمالي القطع
  conversionFactor: number;       // معامل التحويل
  bulkUnit?: string;              // اسم الوحدة الكبرى
  smallUnit?: string;             // اسم الوحدة الصغرى
  showTotal?: boolean;            // إظهار المجموع
  size?: 'sm' | 'md' | 'lg';      // حجم العرض
}
```

### تحديث UnitSettingsTab
- إضافة خانتين منفصلتين: `bulkQuantity` و `extraPieces`
- حساب `totalPieces = bulkQuantity * conversionFactor + extraPieces`
- تمرير القيمة للأعلى عبر `onChange`

### تحديث Products.tsx (واجهة التعديل)
- استبدال خانة الكمية الواحدة بخانتين
- إظهار الحساب التلقائي للمجموع
- عند فتح التعديل: تحويل القطع إلى كراتين + قطع

---

## بروتوكول التحقق

1. **اختبار الإضافة**:
   - أضف منتج "شوكولاتة"
   - أدخل: 10 كراتين + 5 قطع، معامل التحويل = 20
   - تأكد أن المجموع يظهر: 205 قطعة

2. **اختبار العرض**:
   - تأكد أن الجدول يظهر: `[10 كرتونة] [5 قطعة]`
   - تأكد أن المجموع يظهر تحتها: "205 قطعة"

3. **اختبار التعديل**:
   - افتح المنتج للتعديل
   - تأكد أن الخانتين تظهران: 10 كراتين، 5 قطع
   - غيّر إلى 9 كراتين + 17 قطعة
   - تأكد أن المجموع يظهر: 197 قطعة

4. **اختبار POS**:
   - افتح نقطة البيع
   - تأكد أن كل منتج يظهر الخانتين الصغيرتين

---

## النتيجة المتوقعة

واجهة احترافية وواضحة تعرض:
- الكراتين الكاملة في خانة منفصلة
- القطع المتبقية في خانة منفصلة
- المجموع الكلي بالقطع
- إدخال سهل للمخزون بخانتين منفصلتين
