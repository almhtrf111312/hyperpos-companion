
# خطة شاملة: إصلاح مشكلة الكاميرا وتحسين المزامنة

## المرحلة 1: إصلاح إعادة تشغيل التطبيق عند التقاط صورة

### المشكلة الحالية
الكود يستخدم `CameraResultType.Uri` ثم يقرأ الملف بالكامل إلى base64 عبر `Filesystem.readFile()` ثم يضغطه في الذاكرة. هذا يستهلك ذاكرة كبيرة على أجهزة الأندرويد الضعيفة مما يسبب إغلاق التطبيق.

### الحل
تعديل `use-camera.tsx` لاستخدام `webPath` بدلاً من قراءة الملف كـ base64:

1. **استخدام `photo.webPath` مع `fetch` للحصول على Blob مباشرة** - بدلاً من `Filesystem.readFile` الذي يحمل الملف كله في الذاكرة كـ base64
2. **ضغط الصورة عبر Blob/Canvas** بدون تحويل وسيط لـ base64
3. **التأكد من طلب الأذونات** عبر `Camera.checkPermissions()` قبل فتح الكاميرا

### التغييرات في `src/hooks/use-camera.tsx`:
- دالة `takePhoto`: استخدام `photo.webPath` مع `fetch()` للحصول على Blob، ثم تحويله لـ canvas للضغط، ثم إرجاع base64 مضغوط
- دالة `pickFromGallery`: نفس التحسين
- إضافة `checkPermissions` قبل فتح الكاميرا
- تحسين listener الـ `appRestoredResult` لاستخدام `webPath`

### التغييرات في `capacitor.config.json`:
- إضافة `"saveToGallery": false` لمنع حفظ نسخة إضافية في المعرض

---

## المرحلة 2: تفعيل حفظ حالة النموذج (Form State Persistence)

### المشكلة
ملف `form-persistence.ts` موجود لكنه غير مستخدم في أي مكان. صفحة `Products.tsx` تستخدم نظام حفظ خاص بها لكنه لا يغطي كل الحالات.

### الحل
النظام الحالي في `Products.tsx` (سطور 272-328) يعمل بشكل جيد بالفعل:
- يحفظ بيانات النموذج تلقائياً عند تغييرها
- يستعيدها عند إعادة تشغيل التطبيق
- ينظفها عند إغلاق الحوار

التحسين المطلوب: حفظ الصورة المرفوعة (URL) مع بيانات النموذج حتى لا تضيع بعد إعادة التشغيل - وهذا يحدث تلقائياً لأن `formData.image` يُحفظ ضمن الـ state.

---

## المرحلة 3: تحسين المزامنة (Incremental Sync)

### المشكلة الحالية
`loadProductsCloud()` يجلب جميع المنتجات من السحابة في كل مرة (`fetchFromSupabase('products')`). مع بيانات كبيرة، هذا بطيء.

### الحل: مزامنة تزايدية (Delta Sync)

#### التغييرات في `src/lib/cloud/products-cloud.ts`:
1. **حفظ آخر وقت مزامنة** (`lastSyncTimestamp`) في localStorage
2. **جلب التعديلات فقط**: عند المزامنة، جلب المنتجات التي `updated_at > lastSyncTimestamp` فقط
3. **دمج التعديلات مع الكاش**: تحديث المنتجات المتغيرة في الكاش المحلي بدلاً من استبدال الكل
4. **مزامنة كاملة أولية**: أول مرة فقط يتم جلب كل شيء، بعدها تزايدي

#### التغييرات في `src/lib/supabase-store.ts`:
- إضافة دالة `fetchIncrementalFromSupabase` تقبل `since` timestamp وتجلب السجلات المحدثة فقط

#### التغييرات في `src/lib/cloud/products-cloud.ts`:
- تعديل `loadProductsCloud` لاستخدام المزامنة التزايدية
- إضافة منطق دمج المنتجات الجديدة/المحدثة مع الكاش

---

## المرحلة 4: فصل رفع الصور عن المزامنة

### الوضع الحالي
الصور تُرفع فوراً عند التقاطها عبر `uploadProductImage()` قبل حفظ المنتج. هذا يعمل بشكل صحيح بالفعل - الصورة تُرفع للتخزين السحابي وفقط الرابط (URL) يُحفظ في قاعدة البيانات.

### لا يحتاج تعديل
هذا الجزء مطبق بشكل صحيح:
- الصور تُرفع لـ Storage منفصلة عن البيانات النصية
- فقط URL الصورة يُخزن في عمود `image_url` في جدول المنتجات
- لا توجد صور داخل المزامنة النصية

---

## ملخص الملفات المعدّلة

| الملف | التعديل |
|-------|---------|
| `src/hooks/use-camera.tsx` | استخدام webPath + fetch للـ Blob بدلاً من readFile + base64 |
| `src/lib/cloud/products-cloud.ts` | مزامنة تزايدية (delta sync) بدلاً من جلب الكل |
| `src/lib/supabase-store.ts` | إضافة دالة `fetchIncrementalFromSupabase` |
| `capacitor.config.json` | إضافة `saveToGallery: false` |

## الأولوية
1. إصلاح الكاميرا (المرحلة 1) - أهم شيء لأنه يسبب فقدان بيانات
2. المزامنة التزايدية (المرحلة 3) - لتحسين الأداء مع البيانات الكبيرة
