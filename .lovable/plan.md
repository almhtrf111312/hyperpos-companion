
# خطة تسريع فتح التطبيق وتحليل ترابط البيانات

## المشكلة الرئيسية: تأخير شاشة "جاري التحميل"

عند فتح التطبيق، يتم تنفيذ 3 عمليات شبكية **بالتتابع** قبل عرض أي محتوى:

```text
Auth (getSession + getUser + fetchProfile)
  --> License (check-license edge function)
    --> Device Binding (user_roles + app_licenses queries)
```

كل عملية تنتظر الأخرى. إذا كان الاتصال بطيئاً، يمكن أن يستغرق الأمر 10-20 ثانية.

---

## الجزء الأول: تسريع فتح التطبيق (3 تعديلات)

### 1. كاش محلي لنتيجة الترخيص (الحل الأساسي)
حفظ آخر نتيجة ناجحة من `check-license` في localStorage. عند فتح التطبيق:
- عرض التطبيق فوراً بناءً على الكاش المحلي
- تحديث الترخيص في الخلفية بدون حظر الواجهة

**الملف:** `src/hooks/use-license.tsx`
- إضافة `LICENSE_CACHE_KEY` لحفظ آخر نتيجة ناجحة
- عند التهيئة: تحميل الكاش أولاً → تعيين `isLoading = false` فوراً → ثم التحقق من السحابة في الخلفية

### 2. كاش محلي لفحص الجهاز
حفظ آخر نتيجة ناجحة من فحص Device Binding.

**الملف:** `src/hooks/use-device-binding.tsx`
- حفظ `deviceId` و `isBlocked` في localStorage
- عند التهيئة: تحميل الكاش فوراً → تحديث في الخلفية

### 3. تقليل timeout شاشة التحميل
تقليل timeout من 5 ثواني إلى 3 ثواني وإضافة زر "تخطي والدخول" بعد 6 ثواني.

**الملف:** `src/components/license/LicenseGuard.tsx`
- تقليل timeout إلى 3 ثواني
- إضافة زر "تخطي والدخول" بعد 6 ثواني يعرض التطبيق مباشرة

---

## الجزء الثاني: تسريع تهيئة الثيم
حالياً `ThemeProvider` يستدعي `supabase.auth.getUser()` عند كل فتح، مما يضيف تأخيراً إضافياً.

**الملف:** `src/hooks/use-theme.tsx`
- تحميل الثيم من localStorage أولاً وفوراً (بدون await)
- مزامنة من السحابة في الخلفية فقط (لا يحظر العرض)

---

## الجزء الثالث: تحليل وتصحيح ترابط البيانات

### تدفق البيع النقدي (التحقق من صحته)
```text
بيع منتج
  |-- إنشاء فاتورة (invoices + invoice_items)
  |-- خصم المخزون (products.quantity أو warehouse_stock)
  |-- تحديث إحصائيات العميل (customers.total_purchases)
  |-- تسجيل الربح (profits-store)
  |-- توزيع الربح على الشركاء (partners.current_balance)
  |-- إضافة للوردية (cashbox-store)
```

### تدفق البيع بالدين
```text
بيع بالدين
  |-- إنشاء فاتورة (status: pending, paymentType: debt)
  |-- إنشاء سجل دين (debts table)
  |-- خصم المخزون
  |-- تحديث العميل (total_debt + total_purchases)
  |-- تسجيل الربح + توزيع على الشركاء
  |-- لا يُضاف للصندوق (لأنه دين)
```

### تدفق المصاريف
```text
إضافة مصروف
  |-- إنشاء سجل مصروف (expenses table)
  |-- خصم من أرصدة الشركاء حسب نسبة المشاركة
```

### ما يجب التحقق منه وإصلاحه:

1. **CartPanel.tsx**: التأكد أن البيع بالدين لا يُضاف للصندوق/الوردية
2. **CartPanel.tsx**: التأكد أن توزيع الأرباح يتم بشكل صحيح للشركاء عند كل بيع
3. **CartPanel.tsx**: التأكد أن خصم المخزون يتم من المستودع الصحيح
4. **Debts**: التأكد أن تسديد دين يُحدّث حقل `debt_paid` و `debt_remaining` في الفاتورة المرتبطة
5. **Expenses**: التأكد أن المصاريف تُخصم من أرصدة الشركاء بالنسبة الصحيحة

---

## التفاصيل التقنية

### نمط كاش الترخيص الجديد (use-license.tsx)

```text
فتح التطبيق
  |
  +-- هل يوجد كاش ترخيص محلي؟
  |     |
  |     +-- نعم --> عرض التطبيق فوراً + isLoading = false
  |     |            |
  |     |            +-- تحديث من السحابة في الخلفية
  |     |
  |     +-- لا --> عرض شاشة التحميل (كالعادة)
  |                  |
  |                  +-- فحص الترخيص من السحابة
```

### الملفات المتأثرة
1. `src/hooks/use-license.tsx` - كاش محلي للترخيص + تحميل خلفي
2. `src/hooks/use-device-binding.tsx` - كاش محلي لفحص الجهاز
3. `src/components/license/LicenseGuard.tsx` - تقليل timeout + زر تخطي
4. `src/hooks/use-theme.tsx` - تحميل localStorage أولاً بدون حظر
5. `src/components/pos/CartPanel.tsx` - مراجعة وتصحيح تدفقات البيع إذا لزم الأمر

### النتيجة المتوقعة
- فتح التطبيق خلال أقل من ثانية واحدة (من الكاش المحلي)
- تحديث البيانات في الخلفية بدون تأثير على تجربة المستخدم
- ترابط صحيح بين جميع وحدات البيانات (فواتير، مخزون، ديون، شركاء، مصاريف)
