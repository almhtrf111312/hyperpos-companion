

# خطة إصلاح مشكلتي قارئ الباركود وحظر جهاز حساب البوس

## تحليل المشاكل

### المشكلة 1: قارئ الباركود يعيد تحميل الصفحة (APK)

**السبب الجذري:** عند استخدام `BarcodeScanner.scan()` من مكتبة ML Kit، يفتح نشاط (Activity) أصلي منفصل لقراءة الباركود. عندما يعود هذا النشاط، يقوم Android بإعادة إنشاء WebView (Activity Recreation)، مما يعيد تحميل الصفحة بالكامل.

النظام الحالي يحفظ الباركود في `localStorage` عبر `PENDING_BARCODE_KEY`، ثم يقرأه `ProductGrid` عند التحميل. لكن المشكلة أن:
1. بعد إعادة التحميل، يمر التطبيق بمراحل التحقق من الترخيص والجلسة قبل أن يصل لصفحة POS
2. الباركود قد يُقرأ ويُعالج قبل أن تكون المنتجات جاهزة
3. قد يحدث خطأ غير معالج (uncaught error) يمنع استعادة الباركود

**الحل:**
- إضافة معالجة الباركود المعلق في مكون `POS.tsx` (المستوى الأعلى) بدلاً من `ProductGrid` فقط
- إضافة تأخير أطول وآلية إعادة محاولة لضمان جاهزية البيانات
- إضافة `try/catch` شامل حول منطق المسح لمنع أي أخطاء غير معالجة
- التأكد من أن `handleBarcodeScan` في POS.tsx يمسح `PENDING_BARCODE_KEY` بعد المعالجة الناجحة

### المشكلة 2: حساب البوس محظور بسبب تعدد الأجهزة

**السبب الجذري:** في `use-device-binding.tsx` السطر 82، يتم التحقق من `roleData?.role === 'boss'`. إذا كان حساب البوس له `role = 'admin'` في قاعدة البيانات (وهو المحتمل بناءً على trigger `handle_new_user_role` الذي يعطي `admin` للمسجلين مباشرة)، فلن يتم استثناؤه.

كذلك، عند تسجيل الدخول من APK يتم تسجيل `device_id` في `app_licenses`. ثم عند تسجيل الدخول من المتصفح، يكون `device_id` مختلفاً فيظهر حظر الجهاز.

**الحل:**
- توسيع شرط الاستثناء ليشمل `'admin'` بالإضافة لـ `'boss'` — أو الأفضل: التحقق أيضاً من `allow_multi_device` قبل فحص تطابق الجهاز (وهذا موجود فعلاً)
- الأصح: التأكد من أن حساب البوس في قاعدة البيانات يحمل الصلاحية الصحيحة (`boss` أو `allow_multi_device = true`)
- إضافة فحص إضافي: إذا لم يكن للمستخدم ترخيص أصلاً (حساب admin/owner بدون license)، لا يتم حظره

## التغييرات المطلوبة

### 1. `src/hooks/use-device-binding.tsx`
- تعديل شرط الاستثناء ليشمل `'admin'` و `'boss'` معاً (كلاهما مالك لا يجب حظره)
- السطر 82: `if (roleData?.role === 'boss' || roleData?.role === 'admin')` بدلاً من `=== 'boss'` فقط

### 2. `src/pages/POS.tsx`
- إضافة `useEffect` لمعالجة `PENDING_BARCODE_KEY` عند التحميل بتأخير مناسب (بعد تحميل المنتجات)
- التأكد من أن `handleBarcodeScan` يمسح المفتاح من localStorage

### 3. `src/components/barcode/NativeMLKitScanner.tsx`
- إضافة `try/catch` أشمل حول كامل منطق `handleBarcode`
- التأكد من حفظ الباركود في `localStorage` قبل أي عملية أخرى

### 4. `src/components/pos/ProductGrid.tsx`
- تحسين منطق استعادة الباركود المعلق مع تأخير أطول وإعادة محاولة

## ملاحظة تقنية
الإصلاح الأساسي لحساب البوس هو تغيير سطر واحد في `use-device-binding.tsx`. أما إصلاح الباركود فيتطلب تحسين آلية الاسترداد بعد إعادة التحميل عبر عدة ملفات.

