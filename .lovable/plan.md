
# خطة إضافة ميزة "استرداد العهدة" (Stock Return)

## ملخص
إضافة زر "استرداد عهدة" في صفحة تحويل العهدة يسمح باسترداد منتجات من مستودع موزع وإعادتها للمخزون الرئيسي (products.quantity).

## آلية العمل
1. يضغط المستخدم على زر "استرداد عهدة" بجانب زر "إنشاء أمر صرف"
2. يختار مستودع الموزع (المصدر)
3. يظهر فقط المنتجات المتوفرة في مخزن هذا الموزع مع كمياتها
4. يحدد المنتجات والكميات المراد استردادها
5. عند التأكيد:
   - تُخصم الكميات من warehouse_stock (مخزن الموزع)
   - تُضاف إلى products.quantity (المخزون الرئيسي)
   - يُسجل التحويل بنوع "return" في سجل التحويلات
   - يُطبع وصل استرداد تلقائيا

---

## التفاصيل التقنية

### 1. تعديل قاعدة البيانات (Migration)
إضافة عمود `transfer_type` لجدول `stock_transfers`:

```text
ALTER TABLE public.stock_transfers
  ADD COLUMN transfer_type text NOT NULL DEFAULT 'outgoing';

-- القيم: 'outgoing' (صرف عادي) | 'return' (استرداد)
```

### 2. دالة الاسترداد في `warehouses-cloud.ts`
- دالة `createReturnTransferCloud()`: تنشئ سجل تحويل بنوع `return` (from = موزع، to = رئيسي)
- دالة `completeReturnTransferCloud()`: عند التأكيد تقوم بـ:
  - خصم من `warehouse_stock` (مخزن الموزع)
  - إضافة إلى `products.quantity` (المخزون الرئيسي)
  - تحديث حالة التحويل إلى `completed`
- دالة `getDistributorAvailableProducts()`: تجلب المنتجات المتوفرة فعليا في مخزن موزع معين

### 3. تعديل واجهة `StockTransfer.tsx`
- زر "استرداد عهدة" جديد بجانب زر "إنشاء أمر صرف"
- نافذة حوار جديدة:
  - اختيار الموزع (المصدر) اولا
  - عرض قائمة المنتجات المتوفرة في مخزنه فقط مع الكميات المتاحة
  - التحقق من ان الكمية المطلوبة لا تتجاوز المتوفر
- شارة (Badge) في سجل التحويلات لتمييز نوع العملية: "صرف" / "استرداد"
- رقم التحويل يبدأ بـ `RTN-` بدلا من `TRF-` للتمييز

### 4. ترجمات جديدة في `i18n.ts`
- "استرداد عهدة" / "Return Stock"
- "تأكيد الاسترداد" / "Confirm Return"
- "تم الاسترداد بنجاح" / "Return completed"
- "المنتجات المتاحة للاسترداد" / "Available products for return"

### 5. تحديث نوع StockTransfer
- إضافة خاصية `transfer_type?: 'outgoing' | 'return'` للواجهة البرمجية
- سيتم تحديث `types.ts` تلقائيا بعد الـ migration

---

## الملفات المتأثرة

| الملف | التغيير |
|:---|:---|
| Migration جديدة | إضافة عمود `transfer_type` |
| `src/lib/cloud/warehouses-cloud.ts` | دوال الاسترداد الجديدة |
| `src/pages/StockTransfer.tsx` | نافذة حوار الاسترداد + شارة النوع |
| `src/lib/i18n.ts` | ترجمات الاسترداد |
