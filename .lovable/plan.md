
# خطة التنفيذ على مراحل

## ملاحظة عن VPN
معرف الجهاز (Device ID) يعتمد على UUID عشوائي مخزن في localStorage وليس على عنوان IP، لذا فتح VPN لا يغير بصمة الجهاز. لا حاجة لأي تعديل.

---

## المرحلة 1: إصلاح التمرير في النوافذ المنبثقة (Dialog)

**المشكلة**: النوافذ المنبثقة لا تدعم التمرير عند تجاوز المحتوى لحجم الشاشة، مما يخفي الأزرار وزر الإغلاق.

**الحل**: تعديل مكون `DialogContent` في `src/components/ui/dialog.tsx` لإضافة:
- `max-h-[90vh]` لمنع تجاوز النافذة لحجم الشاشة
- `overflow-y-auto` للسماح بالتمرير داخل النافذة
- التأكد من أن زر الإغلاق (X) يظهر بشكل واضح ومتوافق مع RTL

---

## المرحلة 2: إنشاء Edge Function لنقل الترخيص

**الهدف**: إنشاء وظيفة `transfer-license` في الخادم تقوم بـ:
1. التحقق من كلمة مرور المستخدم
2. مسح `device_id` من جدول `app_licenses`
3. تسجيل عملية النقل

**الملف الجديد**: `supabase/functions/transfer-license/index.ts`

**المنطق**:
- يستقبل `email` و `password`
- يتحقق من صحة بيانات الدخول عبر `signInWithPassword`
- يمسح `device_id` من سجل الترخيص النشط
- يعيد رسالة نجاح

**ملاحظة**: يشبه `reset-own-device` الموجود لكن هذا مخصص للاستخدام من داخل التطبيق (المستخدم مسجل دخوله) مع تسجيل خروج قسري بعدها.

---

## المرحلة 3: إضافة زر "نقل الترخيص" في الإعدادات

**الملف المتأثر**: `src/pages/Settings.tsx`

**التنفيذ**:
- إضافة زر "نقل الترخيص لجهاز آخر" في قسم الترخيص أو أسفل الإعدادات
- عند الضغط، تظهر نافذة `AlertDialog` تطلب كلمة المرور
- بعد التأكيد:
  1. يتم استدعاء Edge Function لفك ارتباط الجهاز
  2. مسح localStorage بالكامل
  3. تسجيل خروج قسري عبر `signOut()`
  4. عرض رسالة نجاح: "تم فك ارتباط الجهاز بنجاح. يمكنك التفعيل من الجهاز الجديد."

---

## التفاصيل التقنية

### الملفات المتأثرة:
1. **`src/components/ui/dialog.tsx`** - إضافة `max-h-[90vh] overflow-y-auto` للمحتوى
2. **`supabase/functions/transfer-license/index.ts`** - (ملف جديد) وظيفة فك ارتباط الجهاز مع تحقق كلمة المرور
3. **`supabase/config.toml`** - إضافة `[functions.transfer-license]` مع `verify_jwt = false`
4. **`src/pages/Settings.tsx`** - إضافة زر نقل الترخيص مع نافذة تأكيد كلمة المرور

### ترتيب التنفيذ:
| المرحلة | الوصف | التعقيد |
|---------|-------|---------|
| 1 | إصلاح تمرير النوافذ المنبثقة | منخفض |
| 2 | Edge Function لنقل الترخيص | منخفض |
| 3 | واجهة نقل الترخيص في الإعدادات | متوسط |
