

# خطة إصلاح: تحديث حقول المنتجات تلقائياً عند تغيير نوع المتجر

## المشكلة

عند تغيير نوع المتجر (مثلاً من "هواتف" إلى "بقالة")، حقول إضافة المنتج لا تتغير وتبقى كما كانت. السبب الجذري هو تعارض في حفظ الإعدادات بين المحلي والسحابي:

1. عند حفظ الإعدادات، يتم كتابة `sync_settings` في قاعدة البيانات بإعدادات المزامنة فقط، مما يحذف إعدادات حقول المنتجات من السحابة
2. ثم `saveProductFieldsConfig` يكتب `sync_settings` مرة أخرى بإعدادات الحقول فقط، مما يحذف إعدادات المزامنة
3. عند إعادة فتح التطبيق، يتم جلب الإعدادات من السحابة وقد تكون قديمة أو محذوفة

## الحل

### 1. إصلاح `saveProductFieldsConfig` في `src/lib/product-fields-config.ts`

بدلاً من استبدال عمود `sync_settings` بالكامل، يجب قراءة القيمة الحالية أولاً ثم دمج `productFieldsConfig` فيها:

```text
1. قراءة sync_settings الحالية من جدول stores
2. دمج productFieldsConfig في الكائن الموجود
3. كتابة الكائن المدمج مرة واحدة
```

### 2. إصلاح `handleSaveSettings` في `src/pages/Settings.tsx`

عند حفظ الإعدادات العامة، يجب دمج `sync_settings` مع إعدادات حقول المنتجات الموجودة بدلاً من استبدالها:

```text
1. إذا كان productFieldsChanged = true، دمج productFieldsConfig مع syncSettings قبل الإرسال
2. إرسال sync_settings مدمجة تحتوي على كلا النوعين من الإعدادات
3. إزالة الاستدعاء المنفصل لـ saveProductFieldsConfig (لأنه أصبح مدمجاً)
```

### 3. إصلاح `getEffectiveFieldsConfig` في `src/lib/product-fields-config.ts`

إضافة فحص إضافي: إذا كان نوع المتجر المحفوظ لا يتطابق مع الإعدادات المخزنة، إعادة الإعدادات الافتراضية للنوع الجديد.

---

## التفاصيل التقنية

### الملفات المتأثرة:
- `src/lib/product-fields-config.ts` - إصلاح دمج sync_settings في السحابة
- `src/pages/Settings.tsx` - إصلاح حفظ الإعدادات المدمجة

### خطوات التنفيذ:

**الخطوة 1**: تعديل `saveProductFieldsConfig` لقراءة `sync_settings` الحالية ودمج الحقول الجديدة بدلاً من الاستبدال الكامل

**الخطوة 2**: تعديل `handleSaveSettings` لدمج `productFieldsConfig` داخل كائن `sync_settings` المرسل إلى `saveStoreSettings`، بحيث يتم إرسال كل شيء في عملية واحدة

**الخطوة 3**: حفظ إعدادات الحقول إلى localStorage فوراً عند تغيير نوع المتجر (وليس فقط عند الضغط على حفظ) لضمان تطبيقها مباشرة على نموذج إضافة المنتجات

