

# اصلاح مشكلة عدم ظهور بعض الحسابات في الاعدادات

## التحليل

بعد فحص الكود وقاعدة البيانات، وجدت ان حساب الكاشير "عمر الخالد" موجود في قاعدة البيانات بشكل صحيح (user_roles + profiles). المشكلة المحتملة تكمن في عدة نقاط:

1. **استعلام `user_roles` في `fetchUsers` لا يجلب عمود `owner_id`** - مما يعني ان النظام لا يستطيع تحديد الحسابات التابعة لكل مالك بدقة.

2. **لا يوجد فلترة حسب المالك** - حساب البوس يرى جميع المستخدمين من جميع المالكين، مما قد يسبب ارباكا. يجب ان يرى البوس كل شيء ولكن مع تصنيف واضح.

3. **تحديد المالك غير دقيق** - الكود يحدد "المالك" كاول حساب admin فقط (سطر 60)، ولا ياخذ بعين الاعتبار ان البوس ايضا يملك حسابات تابعة.

## الحل المقترح

### التعديل 1: جلب `owner_id` في استعلام `user_roles`
في ملف `src/hooks/use-users-management.tsx`، تعديل استعلام `user_roles` ليشمل عمود `owner_id`:
```
.select('id, user_id, role, created_at, owner_id')
```

### التعديل 2: تحسين منطق تحديد المالك
بدلا من البحث عن اول admin فقط، يتم تحديد المالك بناء على `owner_id`:
- اذا كان المستخدم الحالي boss، يعتبر مالكا لكل حساب `owner_id` يشير اليه
- اذا كان admin، يعتبر مالكا لحساباته التابعة فقط

### التعديل 3: اضافة سجل تصحيحي (Debug Log)
اضافة `console.log` مؤقت لعرض عدد الحسابات المجلوبة والمعروضة، لتسهيل تشخيص اي مشاكل مستقبلية.

### التعديل 4: التعامل مع الحالات الاستثنائية
- اذا لم يكن للكاشير ملف شخصي (profile)، يظهر برسالة "بدون اسم" بدلا من اخفائه
- اضافة معالجة افضل للاخطاء عند فشل جلب البيانات

## التفاصيل التقنية

### الملف: `src/hooks/use-users-management.tsx`

**التغيير الرئيسي في `fetchUsers`:**

```typescript
// 1. جلب owner_id مع بيانات الادوار
const { data: rolesData } = await supabase
  .from('user_roles')
  .select('id, user_id, role, created_at, owner_id');

// 2. تحديد المالك بشكل صحيح
const currentUserId = currentUser?.id;
const ownerUserId = sortedRoles.find(r => 
  r.role === 'admin' || r.role === 'boss'
)?.user_id;

// 3. اضافة سجل تصحيحي
console.log(`[Users] Fetched ${rolesData?.length} roles, ${profilesData?.length} profiles`);
```

**النتيجة المتوقعة:**
- جميع الحسابات التابعة للبوس تظهر في قائمة ادارة المستخدمين
- كل حساب يعرض بياناته بشكل صحيح (الاسم، البريد، الدور)
- الحسابات التي ليس لها ملف شخصي تظهر بدلا من الاختفاء

