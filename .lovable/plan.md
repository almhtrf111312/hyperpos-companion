
# تسريع عملية البيع: تطبيق نموذج "محلي أولاً" (Local-First Sale)

## تقييم الوضع الحالي

التطبيق يمتلك بنية تحتية للعمل أوفلاين موجودة بالفعل (sync-queue، IndexedDB للمنتجات، مزامنة خلفية)، لكن مشكلة البطء تأتي من مسار **عملية البيع عند توفر الإنترنت**.

### سبب البطء الحالي (3-4 ثوانٍ)

عند الضغط على "بيع نقدي" مع وجود اتصال، يتم تنفيذ الخطوات التالية **بالتسلسل** وينتظر المستخدم اكتمالها كلها:

```text
1. checkStockAvailabilityCloud()   ← طلب للسيرفر
2. findOrCreateCustomerCloud()     ← طلب للسيرفر
3. loadProductsCloud()             ← طلب للسيرفر (لحساب الأرباح)
4. addInvoiceCloud()               ← طلب للسيرفر
5. distributeDetailedProfitCloud() ← طلب للسيرفر
6. deductStockBatchCloud()         ← طلب للسيرفر
7. updateCustomerStatsCloud()      ← طلب للسيرفر
```

المستخدم ينتظر **جميع هذه الطلبات** قبل أن يرى أي نتيجة.

بالمقابل، في وضع الأوفلاين، تتم العملية **فوراً** لأن الكود يحفظ في الطابور محلياً مباشرة.

## الحل: توحيد مسار البيع ليكون "محلي أولاً" دائماً

### المبدأ الجديد

```text
الوضع الحالي:
[إنترنت] ← انتظر السيرفر (3-4 ثواني) ← أكمل
[أوفلاين] ← أضف للطابور فوراً ← أكمل

الوضع الجديد:
[إنترنت + أوفلاين] ← أضف للطابور فوراً + أغلق الواجهة
                    ← ارفع للسيرفر في الخلفية فوراً
```

### التغييرات المطلوبة

**الملف الرئيسي: `src/components/pos/CartPanel.tsx`**

تعديل دالتي `confirmCashSale` و `confirmDebtSale` لاتباع نموذج واحد موحد:

1. **حساب الأرباح محلياً:** المنتجات موجودة بالفعل في الكاش المحلي (IndexedDB)، نستخدمها بدلاً من طلب السيرفر
2. **فحص المخزون محلياً:** نستخدم بيانات المنتجات من الكاش بدلاً من `checkStockAvailabilityCloud`
3. **إضافة الفاتورة للطابور فوراً:** حفظ البيانات في sync-queue محلياً وإغلاق الواجهة في أجزاء من الثانية
4. **مزامنة فورية في الخلفية:** إذا كان الإنترنت متاحاً، استدعاء `syncNow()` مباشرة بعد الحفظ المحلي

**الملف الداعم: `src/lib/cloud/cash-sale-handler.ts`**

لا يحتاج تعديلاً - هو الذي يعالج الطابور عند المزامنة.

### تدفق العملية الجديدة

```text
المستخدم يضغط "بيع"
        ↓
حساب الأرباح من كاش IndexedDB المحلي (0ms)
        ↓
فحص المخزون من كاش IndexedDB (0ms)
        ↓
إضافة الفاتورة لـ sync-queue محلياً (0ms)
        ↓
إغلاق الواجهة + عرض "تم الحفظ" (< 100ms)
        ↓ (في الخلفية بدون انتظار المستخدم)
syncNow() → ترفع الفاتورة للسيرفر في الخلفية
```

### ملاحظة حول فحص المخزون

فحص المخزون الحالي مهم لضمان عدم بيع كمية أكثر مما هو متاح. الحل:
- استخدام بيانات المنتجات من IndexedDB لفحص المخزون محلياً (سريع)
- بعد المزامنة، السيرفر هو المرجع النهائي (يمنع البيع الزائد عند وجود متعدد أجهزة)
- في حالة تعارض المخزون عند المزامنة، يظهر تنبيه للمستخدم

## الملفات التي ستتغير

| الملف | التغيير |
|---|---|
| `src/components/pos/CartPanel.tsx` | إعادة كتابة `confirmCashSale` و`confirmDebtSale` لاستخدام النموذج المحلي أولاً دائماً |
| `src/lib/cloud/cash-sale-handler.ts` | إضافة منطق لحساب الأرباح بدقة من الكاش عند المزامنة (لأن الكاش يحتوي سعر التكلفة) |
| `src/providers/CloudSyncProvider.tsx` | إضافة دالة `syncImmediately()` تُشغَّل بعد كل عملية بيع مباشرة (دون انتظار 30 دقيقة) |

## النتيجة المتوقعة

- **قبل:** 3-4 ثوانٍ لإتمام كل عملية بيع
- **بعد:** أقل من 200 ميلي ثانية (وميض لحظي)
- لا تغيير في سلوك المزامنة أو دقة البيانات
- الثيم الداكن والفاتح لا يتأثران

## ملاحظة مهمة حول تعدد الأجهزة

إذا كان نفس المتجر يستخدم جهازين في نفس الوقت، فإن فحص المخزون المحلي قد يسمح ببيع كمية تجاوزت ما هو متاح (race condition). لحل هذا:
- الكاش يُحدَّث بعد كل مزامنة ناجحة
- يمكن إضافة تحذير إذا كان الكاش قديماً أكثر من 5 دقائق (وقت قابل للتكوين)

هذا التحسين متقدم ويمكن تنفيذه في مرحلة لاحقة إذا كان المستخدم يستخدم أجهزة متعددة بشكل متزامن.
