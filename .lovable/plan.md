
# اعادة تصميم لوحة تحكم البوس وتنظيف التكرارات

## المشاكل المحددة

1. **لوحة البوس غير منظمة** - المحتوى يظهر بشكل متسلسل بدون تقسيم واضح
2. **الحسابات التابعة غير مرئية** - لا يمكن معرفة اي كاشير تابع لاي مالك
3. **ادوات محدودة للحسابات التابعة** - لا يوجد خيار ريست جهاز او تغيير كلمة سر للكاشير من لوحة البوس
4. **وظائف مكررة** بين الاعدادات ولوحة البوس

---

## الحل المقترح

### التعديل 1: تقسيم لوحة البوس الى 4 بطاقات رئيسية

تحويل الصفحة من عرض متسلسل الى 4 اقسام واضحة:

```text
+---------------------------+---------------------------+
|  1. ادارة المالكين        |  2. اكواد التفعيل         |
|  (قائمة الملاك + اضافة)  |  (انشاء/تعديل/حذف)       |
+---------------------------+---------------------------+
|  3. اعدادات النظام        |  4. تشخيص النظام          |
|  (تواصل + اعدادات عامة)  |  (SystemDiagnostics)      |
+---------------------------+---------------------------+
```

### التعديل 2: اظهار الحسابات التابعة لكل مالك

تعديل Edge Function `get-users-with-emails` لارجاع بيانات الكاشيرات مع كل مالك:

- اضافة حقل `cashiers` لكل مالك يحتوي على قائمة الحسابات التابعة (الاسم، البريد، نوع الحساب، حالة النشاط)
- عرض الحسابات التابعة تحت كل مالك في لوحة البوس بشكل شجري

مثال العرض:
```text
احمد (مالك) - ترخيص فعال
  +-- محمد (كاشير)
  +-- خالد (موزع)
  +-- سعاد (نقطة بيع)
```

### التعديل 3: اضافة ادوات ادارة الحسابات التابعة

اضافة خيارات في قائمة الاجراءات (DropdownMenu) لكل حساب تابع:
- تغيير كلمة المرور (عبر Edge Function `admin-change-password`)
- ريست الجهاز (عبر `reset_user_device`)
- تعديل الاسم
- حذف الحساب

### التعديل 4: ازالة التكرارات من الاعدادات

الوظائف التالية مكررة بين الاعدادات ولوحة البوس:
- **تبويب "اتصل بالمطور"** في الاعدادات = **"اعدادات التواصل"** في لوحة البوس - يبقى في كلا المكانين (عرض فقط في الاعدادات، تعديل في البوس)
- **تبويب "المستخدمين"** في الاعدادات - يبقى للمالك العادي (Admin) لادارة حساباته التابعة فقط، بينما البوس يدير الكل من لوحته

---

## التفاصيل التقنية

### الملف: `supabase/functions/get-users-with-emails/index.ts`

تعديل الاستجابة لتشمل الحسابات التابعة:

```typescript
// بدلا من فلترة الكاشيرات، نجمعهم مع مالكيهم
const cashiersByOwner = new Map<string, any[]>()
for (const user of usersWithDetails) {
  if (user.role === 'cashier' && user.owner_id) {
    const list = cashiersByOwner.get(user.owner_id) || []
    list.push({
      user_id: user.user_id,
      email: user.email,
      full_name: user.full_name,
      user_type: profileMap.get(user.user_id)?.user_type || 'cashier',
      is_active: user.is_active,
    })
    cashiersByOwner.set(user.owner_id, list)
  }
}

// اضافة cashiers لكل مالك
const owners = usersWithDetails
  .filter(u => u.role === 'admin' || u.role === 'boss')
  .map(owner => ({
    ...owner,
    cashiers: cashiersByOwner.get(owner.user_id) || [],
  }))
```

### الملف: `src/pages/BossPanel.tsx`

1. تحديث واجهة `Owner` لتشمل `cashiers`
2. تقسيم المحتوى الى 4 بطاقات Cards منفصلة
3. اضافة عرض شجري للحسابات التابعة تحت كل مالك
4. اضافة قائمة اجراءات لكل حساب تابع (تغيير كلمة سر، ريست جهاز، تعديل، حذف)

### الملف: `src/pages/Settings.tsx`

- لا توجد تغييرات كبيرة - تبويب المستخدمين يبقى للمالك العادي
- تبويب "اتصل بالمطور" يبقى كما هو (عرض فقط)

---

## النتيجة المتوقعة

- لوحة بوس منظمة في 4 اقسام واضحة
- كل مالك يظهر معه حساباته التابعة (الاسم، النوع، المالك)
- ادوات ادارة كاملة لكل حساب تابع (كلمة سر، ريست، تعديل، حذف)
- لا وظائف مكررة بين الصفحتين
