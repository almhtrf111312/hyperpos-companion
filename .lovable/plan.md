
## خطة: إصلاح مشاكل الجولة التعليمية على الموبايل

### المشاكل المكتشفة بعد الاختبار

| المشكلة | السبب الجذري |
|---------|-------------|
| القائمة الجانبية لا تفتح أبداً (خطوات 1-8) | زر القائمة `MobileMenuTrigger` لا يملك سمة `data-tour="mobile-menu-trigger"` فالكود يبحث عنها ولا يجدها |
| زر السلة (cart-fab) مخفي خلف البطاقة السفلية | البطاقة السفلية (bottom-sheet) تغطي الزر الموجود في أسفل الشاشة |
| أزرار الدفع (نقدي/دين) مغطاة بالبطاقة | عند فتح السلة، الأزرار في الأسفل والبطاقة تغطيها |
| لا يوجد spotlight على عناصر القائمة الجانبية | العناصر غير موجودة في DOM لأن القائمة مغلقة |

---

### الحلول

#### 1. إضافة `data-tour` لزر القائمة الجانبية
- اضافة `data-tour="mobile-menu-trigger"` على `MobileMenuTrigger` في `Sidebar.tsx`
- هذا يمكّن الجولة من العثور على الزر ونقره لفتح القائمة

#### 2. تحسين منطق فتح القائمة في الجولة
- بعد نقر زر القائمة، الانتظار حتى تظهر عناصر القائمة فعلياً (polling)
- التحقق من وجود العنصر المستهدف قبل إظهار الخطوة

#### 3. رفع المحتوى عند ظهور البطاقة السفلية
- عند خطوة `cart-fab`: إضافة `margin-bottom` مؤقت أو تمرير العنصر ليكون فوق البطاقة
- عند خطوات الدفع: تقليص ارتفاع البطاقة السفلية من `35vh` إلى `25vh` لإظهار الأزرار
- تمرير الأزرار المستهدفة لتكون مرئية فوق البطاقة باستخدام `scrollIntoView`

#### 4. إضافة تأخير كافٍ بين الخطوات
- زيادة `settleDelay` للخطوات التي تتطلب فتح القائمة إلى 700ms
- إضافة polling loop ينتظر ظهور العنصر المستهدف فعلياً (بدل مجرد timeout)

---

### التفاصيل التقنية

#### الملفات المعدلة

| الملف | التغيير |
|-------|---------|
| `src/components/layout/Sidebar.tsx` | إضافة `data-tour="mobile-menu-trigger"` للزر |
| `src/components/onboarding/OnboardingTour.tsx` | إصلاح منطق فتح القائمة + تقليص حجم البطاقة + تحسين التمرير |

#### منطق فتح القائمة المحسّن

```text
عند خطوة requireSidebar على الموبايل:
1. البحث عن العنصر المستهدف مباشرة
2. إذا غير موجود -> البحث عن زر القائمة [data-tour="mobile-menu-trigger"]
3. نقر الزر لفتح القائمة
4. polling كل 100ms حتى يظهر العنصر المستهدف (أقصى 2 ثانية)
5. عند ظهوره -> إظهار spotlight + بطاقة الشرح
```

#### تقليص البطاقة السفلية

```text
الحالة العادية: maxHeight = 28vh (بدل 35vh)
خطوات requireCart: maxHeight = 22vh (لإظهار أزرار الدفع)
خطوة cart-fab: تمرير الزر ليظهر في النصف العلوي من الشاشة
```

#### إصلاح إغلاق القائمة عند الانتقال لخطوات POS

```text
عند الانتقال من خطوة requireSidebar إلى خطوة بدونها:
1. البحث عن زر إغلاق القائمة بشكل أدق (data-radix-dialog-close أو SheetClose)
2. نقره لإغلاق القائمة
3. الانتظار 400ms حتى تختفي القائمة
4. متابعة الخطوة التالية
```
