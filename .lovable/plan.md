
# خطة تحسين نموذج فاتورة الشراء + عرض أسعار الجملة + تعديل السعر الإفرادي

---

## 1. تحسين نموذج إضافة المنتج في فاتورة الشراء

### المشاكل الحالية:
- لا يوجد زر كاميرا لمسح الباركود تلقائياً
- خانة التصنيف عبارة عن Input نصي عادي بدلاً من قائمة منسدلة بالتصنيفات الموجودة
- الحقول المفعلة من الإعدادات موجودة في الكود لكن لا تشمل: إعدادات الوحدة (كرتونة/قطعة)، صورة المنتج، التقاط صورة
- الحقول الديناميكية (صلاحية، تسلسلي، ضمان...) موجودة بالفعل في الكود لكن يجب التأكد من عملها + إضافة الناقص

### الحل:
**الملف: `src/components/products/PurchaseInvoiceItemForm.tsx`**

1. **زر كاميرا للباركود**: إضافة زر بجانب حقل الباركود يفتح `BarcodeScanner` لمسح الباركود تلقائياً
2. **قائمة تصنيفات منسدلة**: استبدال Input التصنيف بـ Select يعرض التصنيفات الموجودة من `getCategoryNamesCloud()`
3. **إعدادات الوحدة المزدوجة**: إضافة حقول:
   - وحدة التتبع (قطعة/كرتونة)
   - اسم الوحدة الكبيرة + الصغيرة
   - معامل التحويل
   - سعر تكلفة الكرتونة + سعر بيع الكرتونة
4. **صورة المنتج**: إضافة زر رفع صورة / التقاط صورة (استخدام نفس نظام رفع الصور من المنتجات)
5. **تمرير البيانات الإضافية**: تحديث الـ interface `onAdd` لتشمل جميع الحقول الجديدة حتى يتم حفظها عند إضافة/تحديث المنتج

---

## 2. عرض أسعار الجملة في سلة المشتريات (وضع الجملة)

### المشكلة الحالية:
- عند تفعيل وضع الجملة، يتم عرض السعر الإجمالي فقط بدون إظهار سعر الجملة الإفرادي لكل منتج
- لا يمكن تعديل السعر الإفرادي يدوياً لكل منتج

### الحل:
**الملف: `src/components/pos/CartPanel.tsx`**

في قسم عرض المنتجات داخل السلة (الأسطر 1202-1267):

1. **عرض سعر الجملة**: عند تفعيل وضع الجملة، يظهر سعر الجملة الإفرادي بجانب كل منتج بلون برتقالي مميز (مثلاً: `$15.00 × 3`)
2. **تعديل السعر الإفرادي يدوياً**: إضافة خانة Input صغيرة بجانب السعر تسمح بتعديل السعر الإفرادي لكل منتج في السلة، سواء في الوضع العادي أو وضع الجملة
   - هذا يفيد عند تقديم خصم خاص لعميل معين
   - السعر المعدّل يظهر في الفاتورة المطبوعة
3. **التحكم بالصلاحية**: تعديل السعر متاح فقط لأصحاب صلاحية `canEditPrice` (Boss و Admin)

### التغييرات التقنية:
- إضافة `onUpdatePrice` callback جديد في `CartPanelProps`
- إضافة دالة `updateItemPrice` في `POS.tsx` لتحديث سعر عنصر معين في السلة
- عند تعديل السعر، يتم إعادة حساب الإجمالي والربح تلقائياً

**الملف: `src/pages/POS.tsx`**
- إضافة دالة `updateItemPrice(id, newPrice, unit)` لتحديث سعر عنصر في السلة
- تمرير الدالة إلى `CartPanel`

---

## ملخص الملفات المتأثرة

| الملف | التغيير |
|-------|---------|
| `src/components/products/PurchaseInvoiceItemForm.tsx` | زر كاميرا باركود + قائمة تصنيفات + حقول الوحدة المزدوجة + صورة المنتج |
| `src/components/pos/CartPanel.tsx` | عرض سعر الجملة الإفرادي + خانة تعديل السعر يدوياً |
| `src/pages/POS.tsx` | إضافة دالة updateItemPrice وتمريرها للسلة |
