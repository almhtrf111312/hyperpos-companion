

# خطة إصلاح 5 مشاكل في الإعدادات والنسخ الاحتياطي

## 1. حقول المنتجات تُفعّل تلقائيا بدون انتظار الحفظ

**المشكلة**: في `ProductFieldsSection.tsx` السطر 56، عند تبديل أي حقل يتم حفظه فورا عبر `saveProductFieldsConfig()` بدون انتظار زر الحفظ العائم.

**الحل**: 
- تغيير `handleToggle` ليقوم فقط بتحديث الـ state المحلي بدون حفظ
- إضافة snapshot مرجعي (مثل Settings.tsx) لتتبع التغييرات
- ربط الحفظ الفعلي بزر الحفظ العائم في الإعدادات عبر رفع الـ state
- بما أن `ProductFieldsSection` هو تبويب داخل الإعدادات، سيتم جعله يُبلّغ Settings.tsx بالتغييرات عبر callback

**التنفيذ**:
- إضافة props `onConfigChange` و `pendingConfig` إلى `ProductFieldsSection`
- في Settings.tsx: تتبع حقول المنتجات ضمن الـ snapshot وضمن `hasUnsavedChanges`
- عند الحفظ في Settings.tsx، يتم حفظ حقول المنتجات أيضا
- عند التراجع، يتم إعادتها لقيمتها الأصلية

## 2. تصغير تبويبات الإعدادات (4 بطاقات في السطر)

**المشكلة**: الشبكة الحالية `grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5` والبطاقات كبيرة.

**الحل**:
- تغيير الشبكة إلى `grid-cols-3 sm:grid-cols-4` للحصول على 4 بطاقات في السطر على معظم الشاشات
- تصغير الأيقونات والنصوص: الأيقونة من `w-12 h-12` إلى `w-10 h-10`، والحشو (padding) من `p-4` إلى `p-3`

## 3. زر الحفظ العائم يغطي الشاشة - تحويله لزر دائري عائم

**المشكلة**: الشريط العائم الحالي (السطور 1552-1585) هو شريط كامل العرض يغطي محتوى الشاشة.

**الحل**: استبداله بزرين دائريين عائمين:
- زر حفظ دائري (أزرق، أيقونة Save) في الزاوية السفلية اليمنى (RTL) أو اليسرى (LTR)
- زر تراجع دائري (رمادي، أيقونة Undo) بجانبه
- حجم صغير مثل FAB (Floating Action Button)
- لا يغطي المحتوى لأنه دائري صغير

## 4. إعادة تسمية زر "تحميل نسخة احتياطية" إلى "حفظ نسخة احتياطية"

**الحل**: تغيير مفتاح الترجمة `settings.downloadBackup` في i18n.ts:
- العربية: "حفظ نسخة احتياطية" بدلا من "تحميل نسخة احتياطية"
- الإنجليزية: "Save Backup" بدلا من "Download Backup"

## 5. النسخ الاحتياطي على الهاتف لا يعمل

**المشكلة**: دالة `handleBackupNow` تستخدم `downloadJSON` التي تحاول الحفظ في Documents ثم Downloads ثم Cache+Share. المشكلة المحتملة:
- عدم طلب صلاحيات التخزين قبل الكتابة
- Filesystem.writeFile تحتاج `encoding` لكن `downloadJSON` تمررها بشكل صحيح

**الحل**:
- إضافة طلب صلاحيات التخزين (`requestStoragePermissions`) قبل محاولة الكتابة في `saveFileNative`
- إضافة دالة لقراءة النسخ الاحتياطية الموجودة في المجلد `Documents/HyperPOS/` على الهاتف
- عرض النسخ الاحتياطية الفعلية من نظام الملفات بدلا من القائمة الثابتة الوهمية الحالية
- إضافة دالة `loadNativeBackups()` تقرأ مجلد `HyperPOS` في Documents وتعرض الملفات الموجودة

---

## الملفات المتأثرة

| الملف | التغيير |
|:---|:---|
| `src/components/settings/ProductFieldsSection.tsx` | إزالة الحفظ التلقائي، إضافة props للتواصل مع Settings |
| `src/pages/Settings.tsx` | تصغير التبويبات، أزرار FAB دائرية، تتبع حقول المنتجات، قراءة النسخ من الهاتف |
| `src/lib/i18n.ts` | تغيير "تحميل نسخة احتياطية" إلى "حفظ نسخة احتياطية" |
| `src/lib/file-download.ts` | إضافة طلب الصلاحيات + دالة قراءة النسخ الاحتياطية من الهاتف |

## التفاصيل التقنية

### الأزرار الدائرية العائمة (FAB)
```text
تصميم الأزرار:
- حجم: w-14 h-14 (56px)
- شكل: rounded-full
- ظل: shadow-lg
- موضع: fixed bottom-6 right-6 (RTL) أو left-6 (LTR)
- زر التراجع بجانبه مع gap
- انتقال سلس: scale-0 إلى scale-100
```

### قراءة النسخ من الهاتف
```text
دالة جديدة في file-download.ts:
- listNativeBackups(): يقرأ مجلد Documents/HyperPOS/
- يعيد قائمة بأسماء الملفات وأحجامها وتواريخها
- تُستخدم في Settings.tsx لعرض النسخ الحقيقية بدلا من البيانات الوهمية
```

### ربط حقول المنتجات بنظام الحفظ الموحد
```text
ProductFieldsSection يرسل التغييرات عبر onConfigChange
Settings.tsx يتتبع productFieldsConfig ضمن hasUnsavedChanges
عند الحفظ: يحفظ حقول المنتجات مع باقي الإعدادات
عند التراجع: يعيدها للقيمة الأصلية
```
