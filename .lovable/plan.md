

# خطة إصلاح تسجيل الدخول التلقائي وعرض المنتجات

## فهم المطلوب

### 1. تسجيل الدخول التلقائي بعد إعادة تثبيت التطبيق
حالياً عند حذف التطبيق وإعادة تثبيته، يُمسح localStorage ويُطلب تسجيل دخول جديد.

**الحل المقترح:** استخدام Device Binding الموجود + التحقق التلقائي عند فتح التطبيق

### 2. صلاحيات عرض المنتجات للكاشير vs الموزع
التأكد من أن الكاشير يرى كل المنتجات، بينما الموزع/نقطة البيع ترى فقط منتجات العهدة.

---

## الخطة التنفيذية

### المرحلة 1: تسجيل الدخول التلقائي (Auto-Login)

#### 1.1 تحديث Edge Function لدعم Device Auto-Login

```text
┌─────────────────────────────────────────────────────────────────┐
│                     تدفق تسجيل الدخول التلقائي                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌──────────────┐                                              │
│   │ فتح التطبيق  │                                              │
│   └──────┬───────┘                                              │
│          ▼                                                      │
│   ┌──────────────────┐                                          │
│   │ هل توجد Session؟ │                                          │
│   └──────┬───────────┘                                          │
│          │                                                      │
│     نعم  ▼          لا ▼                                        │
│   ┌──────────────┐  ┌─────────────────────────┐                 │
│   │ فتح POS      │  │ جلب Device ID           │                 │
│   │ مباشرة       │  │ من device-fingerprint   │                 │
│   └──────────────┘  └───────────┬─────────────┘                 │
│                                 ▼                               │
│                     ┌─────────────────────────┐                 │
│                     │ استدعاء Edge Function   │                 │
│                     │ get-user-by-device      │                 │
│                     └───────────┬─────────────┘                 │
│                                 ▼                               │
│                     ┌─────────────────────────┐                 │
│                     │ هل الجهاز مسجل؟         │                 │
│                     └───────────┬─────────────┘                 │
│                                 │                               │
│                       نعم ▼          لا ▼                       │
│                  ┌──────────────┐  ┌──────────────┐             │
│                  │ تسجيل دخول  │  │ عرض صفحة     │             │
│                  │ تلقائي      │  │ تسجيل الدخول │             │
│                  └──────────────┘  └──────────────┘             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 1.2 إنشاء Edge Function: `get-user-by-device`
- تستقبل `device_id` فقط
- تبحث في `app_licenses` عن الجهاز المسجل
- إذا وُجد: ترجع `user_id` و `email` 
- إذا لم يُوجد: ترجع `null`

#### 1.3 إنشاء Edge Function: `auto-login-device`
- تستقبل `device_id`
- تتحقق من وجود ترخيص صالح للجهاز
- إذا صالح: تُنشئ Session جديدة للمستخدم
- ترجع الـ Session tokens للتطبيق

#### 1.4 تحديث `use-auth.tsx`
- إضافة وظيفة `attemptAutoLogin()`
- عند فتح التطبيق وعدم وجود Session:
  1. جلب Device ID
  2. استدعاء `get-user-by-device`
  3. إذا نجح: تسجيل دخول تلقائي
  4. إذا فشل: توجيه لصفحة تسجيل الدخول

#### 1.5 تحديث `ProtectedRoute.tsx`
- إضافة حالة "جاري التحقق من الجهاز" قبل التوجيه لصفحة تسجيل الدخول

---

### المرحلة 2: تحسين أمان Device Binding

#### 2.1 حفظ آخر Device ID مسجل (في Supabase)
- عند تسجيل الدخول الناجح، يتم تحديث `device_id` في `app_licenses`
- هذا موجود حالياً ✓

#### 2.2 تحسين Device Fingerprint للموبايل
- استخدام `@capacitor/device` للحصول على UUID ثابت
- هذا موجود حالياً ✓

---

### المرحلة 3: التحقق من صلاحيات عرض المنتجات

#### 3.1 مراجعة منطق `POS.tsx`
الكود الحالي صحيح نظرياً:
```typescript
// الكاشير: يرى جميع المنتجات
if (userType === 'cashier' || !userType) {
  setProducts(allPosProducts);
}

// الموزع/نقطة البيع: يرى فقط منتجات العهدة
if ((userType === 'distributor' || userType === 'pos') && activeWarehouse) {
  // جلب مخزون المستودع المخصص فقط
}
```

#### 3.2 إضافة تسجيل Debug لتتبع المشاكل
- طباعة `user_type` من الـ profile
- طباعة `activeWarehouse` للموزع
- طباعة عدد المنتجات المحملة

---

## الملفات المطلوب إنشاؤها/تعديلها

| الملف | العملية | الوصف |
|-------|---------|-------|
| `supabase/functions/get-user-by-device/index.ts` | إنشاء | البحث عن المستخدم بواسطة Device ID |
| `supabase/functions/device-auto-login/index.ts` | إنشاء | تسجيل الدخول التلقائي بالجهاز |
| `src/hooks/use-auth.tsx` | تعديل | إضافة Auto-Login logic |
| `src/components/auth/ProtectedRoute.tsx` | تعديل | دعم حالة "التحقق من الجهاز" |
| `src/pages/Login.tsx` | تعديل | تخطي صفحة الدخول إذا تم Auto-Login |

---

## التفاصيل التقنية

### Edge Function: `get-user-by-device`

```typescript
// Input: { device_id: string }
// Output: { found: boolean, user_id?: string, email?: string }

// 1. البحث في app_licenses عن device_id
// 2. التحقق من أن الترخيص غير ملغي (is_revoked = false)
// 3. التحقق من أن الترخيص لم تنتهِ صلاحيته
// 4. إرجاع بيانات المستخدم إذا وُجد
```

### Edge Function: `device-auto-login`

```typescript
// Input: { device_id: string }
// Output: { success: boolean, session?: {...}, error?: string }

// 1. استدعاء get-user-by-device للتحقق
// 2. إذا وُجد المستخدم، إنشاء Magic Link Token
// 3. تسجيل الدخول نيابة عن المستخدم باستخدام Service Role
// 4. إرجاع الـ Session للتطبيق
```

### تحديث `use-auth.tsx`

```typescript
// إضافة في useEffect الرئيسي:
const attemptDeviceAutoLogin = async () => {
  // 1. التحقق من عدم وجود session حالية
  // 2. جلب Device ID
  // 3. استدعاء device-auto-login
  // 4. إذا نجح: حفظ Session
  // 5. إذا فشل: تعيين isAutoLoginAttempted = true
};
```

---

## ملاحظات أمنية

1. **Device ID ليس كافياً للأمان الكامل**
   - سيُطلب كلمة المرور مرة واحدة على الأقل لربط الجهاز
   - بعدها يتم تسجيل الدخول تلقائياً

2. **تسجيل الخروج يُلغي الربط**
   - عند الضغط على "تسجيل خروج"، يتم مسح ربط الجهاز
   - يُطلب تسجيل دخول يدوي في المرة القادمة

3. **الحماية من سرقة Device ID**
   - الـ Service Role محمي في Edge Function
   - لا يمكن للتطبيق الوصول للـ Session بدون Device ID صحيح

