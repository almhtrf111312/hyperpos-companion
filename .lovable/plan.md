
# خطة التعديلات: 3 مهام منفصلة

## المهمة 1: إعادة صفحة المظهر للقائمة الجانبية مع أزرار عائمة (FABs)

### ما سيتغير:
- **صفحة المظهر** (`src/pages/Appearance.tsx`): إعادة بنائها كصفحة مستقلة كاملة تحتوي على `ThemeSection` + زرين عائمين (حفظ وتراجع) يظهران عند وجود تغييرات
- **صفحة الإعدادات** (`src/pages/Settings.tsx`): إزالة تبويب `appearance` من `settingsTabs`، إزالة `pendingTheme` و `themeHasChanges` و `themeResetSignal`، إزالة منطق حفظ الثيم من `handleSave`، وتنظيف الاستيرادات
- **الراوتر** (`src/App.tsx`): تغيير مسار `/appearance` ليكون ملفوفاً بـ `MainLayout` حتى يظهر الـ Sidebar

### شكل الأزرار العائمة:
زران دائريان `w-14 h-14 rounded-full shadow-lg` ثابتان في الزاوية السفلية، بنفس تصميم FABs الإعدادات تماماً. يظهران فقط عند تغيير أي إعداد في المظهر.

---

## المهمة 2: إصلاح مشكلة مشاركة الفاتورة مع التليجرام

### المشكلة:
تطبيق التليجرام يتجمد عند مشاركة الفاتورة لأن النص يحتوي على أحرف خاصة (مثل `╔══════╗`) وتنسيق ماركداون (`*bold*`) غير متوافق مع التليجرام.

### الحل:
- **تعديل** `src/lib/native-share.ts` > دالة `generateInvoiceShareText`:
  - استبدال الرموز الزخرفية (`╔══╗`, `━━━`) بأسطر بسيطة (`────────`)
  - إزالة تنسيق النجمة `*bold*` الخاص بواتساب واستبداله بنص عادي
  - تقليص طول النص الإجمالي لتجنب حد الأحرف في بعض التطبيقات

---

## المهمة 3: إصلاح مشكلة الطباعة (عدم القدرة على الخروج + دعم بلوتوث)

### المشكلة الأولى - عدم القدرة على الخروج:
على الأندرويد، دالة `printOnNative` في `src/lib/native-print.ts` تحفظ ملف HTML وتشاركه عبر `Share.share()`. بعض تطبيقات عرض HTML تبقى مفتوحة فوق WebView ولا يمكن للمستخدم العودة.

### المشكلة الثانية - دعم طابعة بلوتوث:
`window.print()` لا يدعم طابعات Bluetooth مباشرة في WebView. لكن `Share.share()` يفتح قائمة المشاركة الأصلية التي تتضمن تطبيقات الطابعات (مثل تطبيق الطابعة الحرارية).

### الحل:
- **تعديل** `src/lib/native-print.ts` > دالة `printOnNative`:
  - تحويل الملف من HTML إلى **صورة PNG** باستخدام canvas (أو حفظ كـ HTML مع MIME type صحيح `text/html`)
  - إضافة `dialogTitle: 'طباعة - اختر الطابعة أو التطبيق'` لتوجيه المستخدم
  - التأكد من أن `Share.share()` يعود بشكل صحيح وتنظيف الملفات المؤقتة
- **تعديل** `src/lib/print-utils.ts` > دالة `printHTML`:
  - إضافة زر "إغلاق" داخل محتوى الطباعة HTML نفسه (يظهر فقط على الشاشة ولا يطبع)
  - أو الأفضل: استخدام `native-print.ts` بدلاً من `print-utils.ts` في جميع الأماكن لتوحيد السلوك

---

## التفاصيل التقنية

### الملفات المتأثرة

| الملف | التعديل |
|-------|---------|
| `src/pages/Appearance.tsx` | إعادة بناء كصفحة مستقلة مع FABs |
| `src/pages/Settings.tsx` | إزالة تبويب appearance ومنطق الثيم |
| `src/App.tsx` | إضافة MainLayout لمسار /appearance |
| `src/lib/native-share.ts` | تبسيط نص الفاتورة للتوافق مع التليجرام |
| `src/lib/native-print.ts` | تحسين الطباعة الأصلية وتنظيف الملفات |
| `src/lib/print-utils.ts` | إضافة آلية خروج من معاينة الطباعة |

### آلية عمل Appearance الجديدة

```text
Appearance.tsx (صفحة مستقلة في /appearance)
  |-- useTheme() -> قراءة القيم الحالية
  |-- pendingTheme state
  |-- hasChanges state  
  |-- resetSignal state
  |
  |-- <ThemeSection onPendingChange={callback} resetSignal={signal} />
  |
  |-- FABs (تظهر عند hasChanges فقط):
      |-- حفظ -> setFullTheme(pending)
      |-- تراجع -> increment resetSignal
```

### إصلاح نص المشاركة

```text
قبل (يسبب تجمد التليجرام):
╔══════════════════════╗
      *اسم المتجر*
╚══════════════════════╝

بعد (متوافق مع جميع التطبيقات):
────────────────
اسم المتجر
────────────────
```
