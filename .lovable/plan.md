

# خطة فحص وإصلاح عزل بيانات المستودعات

## الوضع الحالي (جيد)

جدول المستودعات (`warehouses`) محمي بالفعل بسياسة RLS صحيحة تستخدم `get_owner_id(auth.uid())` مما يضمن أن كل مالك يرى مستودعاته فقط. لا يوجد عمود `owner_id` في جدول المستودعات -- العمود المستخدم هو `user_id` وهو النمط الصحيح المتبع في جميع جداول المشروع.

## المشاكل المكتشفة

### 1. مستودعات يتيمة (Orphan Warehouses)
يوجد مستودعان مرتبطان بمستخدمين لم يعد لهم سجل في `user_roles`:
- مستودع `5ace15d6...` للمستخدم `7828c256...`
- مستودع `95c5759e...` للمستخدم `626a7123...`

**الإصلاح**: حذف هذين المستودعين لأنهما بيانات يتيمة لا يمكن الوصول إليها.

### 2. مستودع رئيسي مكرر
المستخدم Boss (`174b31d6...`) لديه مستودعان رئيسيان (كلاهما `is_default = true`). هذا قد يسبب تضارب في المنطق البرمجي.

**الإصلاح**: حذف المستودع المكرر والإبقاء على واحد فقط.

### 3. منع التكرار مستقبلاً
إضافة قيد فريد (Unique Constraint) على مستوى قاعدة البيانات لمنع إنشاء أكثر من مستودع رئيسي افتراضي لنفس المالك.

## التفاصيل التقنية

### الخطوة 1: تنظيف البيانات
```text
- حذف المستودعات اليتيمة (2 سجلات)
- حذف المستودع الرئيسي المكرر للـ Boss (1 سجل)
```

### الخطوة 2: إضافة قيد فريد جزئي
إنشاء Partial Unique Index لمنع أكثر من مستودع رئيسي افتراضي لنفس المستخدم:
```text
CREATE UNIQUE INDEX ON warehouses (user_id) 
WHERE type = 'main' AND is_default = true;
```

### ملاحظة مهمة
سياسة RLS الحالية تعمل بشكل صحيح وتمنع تداخل البيانات بين الملاك. لا حاجة لتغيير السياسة الأمنية -- فقط تنظيف البيانات ومنع التكرار.

