

## خطة تنفيذ: كاميرا مضمّنة + مزامنة إعدادات بنظام الإصدارات

### الجزء الأول: كاميرا مضمّنة (Inline Camera Fallback)

#### المشكلة
على بعض أجهزة أندرويد منخفضة المواصفات، فتح تطبيق الكاميرا الخارجي عبر Capacitor Camera يتسبب في "Activity Recreation" - النظام يغلق WebView لتوفير الذاكرة، وعند العودة تُفقد حالة التطبيق.

#### الحل
إضافة مكوّن كاميرا مضمّن يستخدم `navigator.mediaDevices.getUserMedia()` (بدون مكتبات خارجية) كبديل يعمل داخل WebView مباشرة.

**لماذا بدون react-webcam؟** لتجنب إضافة مكتبة جديدة - واجهة `MediaDevices` الأصلية كافية تماماً.

#### الملفات المطلوبة

| الملف | العملية |
|-------|---------|
| `src/components/camera/InlineCamera.tsx` | إنشاء جديد - مكوّن الكاميرا المضمّنة |
| `src/hooks/use-camera.tsx` | تعديل - إضافة خيار `useInlineCamera` كبديل |
| `src/pages/Products.tsx` | تعديل - استخدام InlineCamera عند فشل الكاميرا الخارجية |

#### التفاصيل التقنية

**مكوّن InlineCamera.tsx:**
```text
- يستخدم navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
- يعرض بث الكاميرا في عنصر <video>
- زر "التقاط" يأخذ لقطة عبر Canvas
- يضغط الصورة فوراً (400px / 30KB)
- يُرجع base64 عبر callback onCapture
- زر "إلغاء" لإغلاق الكاميرا
- يعمل كـ overlay ثابت (fixed) بدون Portal
- يدعم الكاميرا الخلفية والأمامية مع زر تبديل
```

**تعديل use-camera.tsx:**
```text
- إضافة خاصية fallbackToInline في الخيارات
- عند فشل Camera.getPhoto (خطأ أو timeout)، يتم تفعيل وضع الكاميرا المضمّنة
- إضافة state: showInlineCamera + onInlineCaptured
```

**تعديل Products.tsx:**
```text
- إضافة InlineCamera كبديل عند فشل الكاميرا الخارجية
- عرض InlineCamera داخل الحوار مباشرة (بدون مغادرة التطبيق)
```

---

### الجزء الثاني: مزامنة الإعدادات بنظام الإصدارات (Settings Version Sync)

#### المشكلة
بعض التحديثات على الإعدادات أو الواجهة لا تصل لكل المستخدمين بسبب:
1. Service Worker يخزّن الملفات القديمة (تم حله سابقاً بـ skipWaiting)
2. إعدادات محلية (localStorage) قد تتعارض مع الإعدادات الجديدة من السحابة

#### الحل
إضافة نظام "رقم إصدار الإعدادات" يفرض تحديث الإعدادات المحلية عند وجود نسخة أحدث.

#### الملفات المطلوبة

| الملف | العملية |
|-------|---------|
| `src/lib/settings-version.ts` | إنشاء جديد - منطق مقارنة الإصدارات وفرض التحديث |
| `src/App.tsx` | تعديل - استدعاء فحص إصدار الإعدادات عند بدء التطبيق |

#### التفاصيل التقنية

**settings-version.ts:**
```text
- ثابت SETTINGS_VERSION = رقم يتم زيادته يدوياً عند كل تحديث مهم
- عند بدء التطبيق: مقارنة الإصدار المحلي مع الإصدار في الكود
- إذا كان الإصدار المحلي أقدم:
  1. مسح الإعدادات المتعارضة من localStorage (مع الاحتفاظ ببيانات المستخدم)
  2. تحديث رقم الإصدار المحلي
  3. لا حاجة لإعادة تحميل - React سيعيد القراءة من localStorage تلقائياً
- قائمة بالمفاتيح التي يجب مسحها عند التحديث (إعدادات الثيم، اللغة، إلخ)
  مع الحفاظ على: بيانات الجلسة، التخزين المؤقت للمنتجات، حالة النموذج
```

**تعديل App.tsx:**
```text
- استدعاء checkSettingsVersion() في useEffect عند أول تحميل
- يعمل بصمت بدون أي واجهة مرئية
```

---

### السلوك المتوقع بعد التنفيذ

1. **الكاميرا**: عند فشل الكاميرا الخارجية، يظهر بث الكاميرا داخل التطبيق مباشرة - لا حاجة لمغادرة التطبيق
2. **الإعدادات**: عند نشر تحديث جديد، يتم تحديث إعدادات جميع المستخدمين تلقائياً عند فتح التطبيق
3. **لا تأثير سلبي**: الكاميرا الخارجية تبقى الخيار الأول (جودة أعلى)، والكاميرا المضمّنة بديل احتياطي فقط

