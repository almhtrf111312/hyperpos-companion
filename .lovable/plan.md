
## خطة إصلاح: حوار الشروط والخصوصية + حوار الجهاز المحظور على الهاتف المحمول (APK)

### المشكلة الاولى: زر "شروط الاستخدام وإخلاء المسؤولية" لا يفتح الحوار على الهاتف

**السبب الجذري:**
شاشة الخصوصية `PrivacyPolicyScreen` تستخدم `fixed inset-0 z-[100]` مما يُنشئ طبقة عالية الـ z-index. حوار Radix Dialog يُرسل محتواه عبر React Portal إلى `<body>` مباشرة بـ `z-50` افتراضياً. في WebView الخاص بـ Capacitor على أندرويد، الطبقة الأم (`z-[100]`) تحجب Portal الحوار (`z-50`) حتى مع محاولة رفع الـ z-index عبر inline style، لأن بعض محركات WebView لا تتعامل مع Portals بنفس طريقة المتصفحات العادية.

**الحل:**
استبدال Radix Dialog بمكوّن عرض مضمّن (inline conditional overlay) داخل نفس الشاشة بدون Portal. هذا يضمن أن المحتوى يُعرض داخل نفس stacking context ولا يحتاج لأي بوابة خارجية.

---

### المشكلة الثانية: حوار "الجهاز مرتبط بهاتف آخر" يظهر ويختفي فوراً

**السبب الجذري:**
في `Login.tsx`، بعد اكتشاف أن الجهاز محظور، يتم استدعاء `supabase.auth.signOut()` ثم عرض الحوار. لكن الحوار يستخدم Radix Dialog العادي بدون حماية من الإغلاق العرضي. على الهاتف المحمول، أحد السيناريوهات التالية يحدث:
1. حدث اللمس (touch event) من الضغط على زر تسجيل الدخول يتسرب (bubble) إلى overlay الحوار فيُغلقه فوراً
2. أو أن WebView في Capacitor لا يعرض Portal الحوار بشكل مستقر

**الحل:**
- إضافة `onPointerDownOutside` و `onInteractOutside` مع `e.preventDefault()` لمنع الإغلاق العرضي
- إضافة `onOpenChange` مخصص يمنع الإغلاق (يجب أن يُغلق فقط بالأزرار الداخلية)
- رفع z-index الحوار ليتجاوز أي طبقة أخرى

---

### الملفات المطلوب تعديلها

| الملف | التعديل |
|-------|---------|
| `src/components/PrivacyPolicyScreen.tsx` | استبدال Radix Dialog بمكوّن overlay مضمّن (بدون Portal) |
| `src/pages/Login.tsx` | إضافة حماية من الإغلاق العرضي لحوار الجهاز المحظور + رفع z-index |

---

### التفاصيل التقنية

#### 1. تعديل PrivacyPolicyScreen.tsx

استبدال الـ `<Dialog>` بالكامل بعنصر `div` شرطي:

```text
- إزالة import Dialog من Radix
- عند dialogOpen === true: عرض div ثابت (fixed) مع z-[150]
  يحتوي على عنوان + ScrollArea + زر إغلاق
- زر الإغلاق يضبط dialogOpen = false
- لا حاجة لـ Portal أو overlay خارجي
- نفس المحتوى (ArabicTerms / EnglishTerms) يُعرض داخل الـ div المضمّن
```

#### 2. تعديل Login.tsx - حوار الجهاز المحظور

```text
- إضافة onPointerDownOutside={(e) => e.preventDefault()}
- إضافة onInteractOutside={(e) => e.preventDefault()}
- تغيير onOpenChange ليمنع الإغلاق:
  onOpenChange={(open) => { if (!open) return; }}
  (الإغلاق يحدث فقط عبر زر "إلغاء" أو "نقل الحساب")
- إضافة style={{ zIndex: 200 }} للحوار
- إخفاء زر X الافتراضي عبر [&>button:last-child]:hidden
```

### السلوك المتوقع بعد الإصلاح
- على الهاتف المحمول (APK): الضغط على "شروط الاستخدام" يفتح قائمة الشروط بشكل صحيح
- حوار "الجهاز مرتبط بهاتف آخر" يظهر ويبقى حتى يضغط المستخدم على "إلغاء" أو "نقل الحساب"
- لا تأثير على المتصفح العادي (نفس السلوك)
