

# إضافة نظام صلاحيات القوائم للحسابات التابعة (كاشير/موزع/نقطة بيع)

## الفكرة
عند إنشاء أو تعديل حساب تابع من الإعدادات، يمكن للمالك تحديد القوائم التي يستطيع هذا الحساب رؤيتها والوصول إليها. مثلاً: السماح للكاشير بالدخول لصفحة المنتجات وإضافة منتجات.

## كيف يعمل النظام

```text
المالك (إعدادات > إدارة المستخدمين > تعديل)
+------------------------------------------+
| الاسم: أحمد                              |
| نوع المستخدم: كاشير                      |
|                                          |
| القوائم المسموح بها:                      |
| [x] لوحة التحكم                          |
| [x] المنتجات                             |
| [ ] الشركاء                              |
| [x] المصاريف                             |
| [ ] التقارير                             |
| [x] المستودعات                           |
| [ ] الإعدادات                            |
+------------------------------------------+
```

عندما يسجل الكاشير دخوله، تظهر له فقط القوائم المسموح بها بالإضافة للقوائم الأساسية (نقطة البيع، الزبائن، الديون، الفواتير).

## التغييرات المطلوبة

### 1. إضافة عمود `allowed_pages` في جدول `profiles`
- عمود من نوع `jsonb` يحتوي على قائمة الصفحات المسموح بها
- القيمة الافتراضية `null` تعني "الصلاحيات الافتراضية حسب الدور"
- مثال القيمة: `["dashboard", "products", "expenses"]`

### 2. تعديل Edge Function `create-user`
- إضافة معالجة حقل `allowedPages` عند إنشاء المستخدم
- حفظه في `profiles.allowed_pages`

### 3. تعديل `use-users-management.tsx`
- إضافة `allowedPages` في `UserData` interface
- تمرير `allowedPages` في `addUser` و `updateUserProfile`
- جلب `allowed_pages` عند تحميل بيانات المستخدمين

### 4. تعديل نموذج إضافة/تعديل المستخدم في `Settings.tsx`
- إضافة قسم "القوائم المسموح بها" مع checkboxes
- يظهر فقط عند إنشاء/تعديل حساب تابع (ليس مالك)
- القوائم المتاحة للتفعيل: لوحة التحكم، المنتجات، الشركاء، المصاريف، التقارير، المستودعات، تحويل العهدة، الإعدادات

### 5. تعديل `use-auth.tsx` لتوفير `allowedPages` في الـ profile
- جلب `allowed_pages` من الـ profile وتوفيرها

### 6. تعديل القائمة الجانبية `Sidebar.tsx`
- إذا كان المستخدم كاشير ولديه `allowedPages` محددة، يتم إخفاء القوائم غير المسموح بها
- القوائم الأساسية (POS، الزبائن، الديون، الفواتير، المظهر، المساعدة) تبقى دائماً ظاهرة

### 7. تعديل `RoleGuard` في `App.tsx`
- إضافة دعم لـ `allowedPages` بحيث إذا كان الكاشير لديه صلاحية لصفحة معينة (مثل المنتجات)، يُسمح له بالدخول بدلاً من إعادة توجيهه

## التفاصيل التقنية

### الملفات المعدّلة:
1. **Migration SQL** - إضافة عمود `allowed_pages jsonb` لجدول `profiles`
2. **`supabase/functions/create-user/index.ts`** - حفظ `allowedPages` عند إنشاء المستخدم
3. **`src/hooks/use-users-management.tsx`** - إضافة `allowedPages` في البيانات والعمليات
4. **`src/hooks/use-auth.tsx`** - جلب `allowed_pages` وتوفيرها
5. **`src/pages/Settings.tsx`** - إضافة واجهة checkboxes في نموذج المستخدم
6. **`src/components/layout/Sidebar.tsx`** - فلترة القوائم حسب الصلاحيات
7. **`src/components/auth/RoleGuard.tsx`** - السماح للكاشير بالوصول للصفحات المسموحة
8. **`src/App.tsx`** - تعديل routes لتدعم الصلاحيات المخصصة

### منطق الصلاحيات:
- المالك (admin/boss): يرى كل شيء دائماً - لا تتأثر صلاحياته
- الكاشير بدون `allowed_pages` (null): الصلاحيات الافتراضية (POS + زبائن + ديون + فواتير + مصاريف + ورديات)
- الكاشير مع `allowed_pages`: الصلاحيات الافتراضية + الصفحات المحددة

### خريطة الصفحات والمسارات:

```text
المفتاح          | الاسم          | المسار
-----------------+----------------+-----------
dashboard        | لوحة التحكم    | /dashboard
products         | المنتجات       | /products
partners         | الشركاء        | /partners
reports          | التقارير       | /reports
warehouses       | المستودعات     | /warehouses
stock-transfer   | تحويل العهدة   | /stock-transfer
settings         | الإعدادات      | /settings
```

