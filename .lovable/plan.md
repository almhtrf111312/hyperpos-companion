
# خطة التحسينات: لوحة البوس + مشكلة التحديث التلقائي

## المشكلة 1: لوحة البوس منحازة وتصميمها مكدس

### السبب الحالي
السطر 738 يحتوي على `pr-14 md:pr-6` مما يسبب انحياز المحتوى لليسار على الهاتف. بالإضافة إلى ذلك، كل بطاقة مستخدم تعرض 6 أزرار مباشرة (تعديل، تفعيل، تعدد، تعيين، إلغاء، حذف) في مساحة صغيرة.

### الحل المقترح: إعادة تصميم شاملة

**1. إصلاح المحاذاة:**
- إزالة `pr-14` واستبداله بـ `rtl:pr-14 ltr:pl-14 md:rtl:pr-6 md:ltr:pl-6` لضمان توافق الاتجاه مع الشريط الجانبي (Sidebar).

**2. بطاقة المستخدم الجديدة:**
- عرض البيانات الأساسية فقط: الاسم، الإيميل، نوع الترخيص، الأيام المتبقية
- إضافة شريط لوني على حافة البطاقة:
  - اخضر = ترخيص فعال
  - احمر = منتهي/ملغى
  - برتقالي = تجريبي
  - ذهبي = Boss
- استبدال الأزرار الـ 6 بزر واحد (ثلاث نقاط `MoreVertical`) يفتح قائمة منسدلة `DropdownMenu` تحتوي على جميع الإجراءات مقسمة لمجموعات:
  - **إدارة الحساب**: تعديل الاسم
  - **إدارة الترخيص**: تعديل التفعيل، تفعيل عن بعد، تعديل كود
  - **إدارة الجهاز**: تعدد الأجهزة، إعادة تعيين الجهاز
  - **خطر**: إلغاء الترخيص، حذف الحساب

**3. تحسينات إضافية:**
- عرض معرف الجهاز بشكل أنظف
- تحسين التباعد والمسافات على الهاتف

---

## المشكلة 2: التحديث التلقائي المفاجئ

### السبب المحتمل
بعد تحليل الكود، وجدت أن `autoRefreshToken: true` في إعدادات Supabase يقوم بتحديث الـ JWT token تلقائيا. عندما يحدث `TOKEN_REFRESHED` في `onAuthStateChange`، يتم استدعاء `fetchProfile` مما قد يسبب إعادة رسم (re-render) لكل المكونات المعتمدة على `useAuth`. هذا لا يعيد تحميل الصفحة لكنه يعيد رسم الشجرة بالكامل مما يغلق الـ Dialogs المفتوحة.

### الحل:
- في `use-auth.tsx`: تجنب استدعاء `fetchProfile` عند `TOKEN_REFRESHED` إذا كان الـ profile محمل مسبقا، لأن تحديث التوكن لا يعني تغيير بيانات المستخدم.
- إضافة شرط `event !== 'TOKEN_REFRESHED'` قبل استدعاء `fetchProfile` للمرة الثانية.

---

## التفاصيل التقنية

### الملفات المتأثرة

**1. `src/pages/BossPanel.tsx`** - إعادة تصميم شاملة:
- إصلاح `pr-14` للمحاذاة الصحيحة
- استبدال قسم الأزرار (سطور 1062-1141) بـ `DropdownMenu` واحد
- إضافة شريط لوني على حافة كل بطاقة مستخدم
- استيراد `DropdownMenu` و `MoreVertical` من المكونات الموجودة

**2. `src/hooks/use-auth.tsx`** - إصلاح التحديث المفاجئ:
- تعديل `onAuthStateChange` لتجنب `fetchProfile` عند `TOKEN_REFRESHED`
- إضافة فحص: إذا كان الـ profile والـ user متاحين بالفعل ولم يتغير `user.id`، لا يتم إعادة جلب البيانات

### ملاحظة عن الأداء
التعديل على `use-auth.tsx` سيمنع إعادة رسم المكونات عند تحديث التوكن، مما يحل مشكلة إغلاق النوافذ المنبثقة أثناء العمل.
