

## خطة: إعادة هيكلة نظام التموضع في الجولة التعليمية

### المشاكل الحالية
1. **تغطية العنصر**: البطاقة التوضيحية تظهر فوق العنصر المشروح مباشرة على الجوال
2. **القائمة الجانبية**: النظام يحاول شرح عناصر مخفية داخل قائمة مغلقة
3. **الموبايل**: البطاقة العائمة تأخذ مساحة كبيرة وتحجب الرؤية

---

### الحل المقترح

#### 1. وضع Bottom-Sheet على الموبايل (التغيير الأكبر)
بدلا من البطاقة العائمة على الجوال، سيتم تثبيت بطاقة الشرح في أسفل الشاشة (position: fixed; bottom: 0) كـ bottom-sheet. هذا يضمن:
- العنصر المشروح يبقى مرئيا دائما في النصف العلوي
- لا يوجد أي تداخل بين البطاقة والعنصر
- تجربة مألوفة لمستخدمي الموبايل

#### 2. تحسين scrollIntoView
قبل إظهار الشرح، يتم تمرير العنصر ليظهر في منتصف الشاشة باستخدام:
```text
scrollIntoView({ behavior: 'smooth', block: 'center' })
```
بدلا من `block: 'nearest'` الحالي

#### 3. تعزيز Pre-Step Hooks
- التحقق من حالة القائمة الجانبية قبل فتحها (منع النقر المزدوج)
- إضافة تأخير كاف (500ms) بعد فتح القائمة/السلة ليستقر التخطيط
- على الموبايل: إغلاق القائمة الجانبية عند الانتقال لخطوات POS

#### 4. تحسين calculatePosition لسطح المكتب
- إضافة فحص تداخل (overlap detection): بعد حساب الموقع، التحقق من أن البطاقة لا تتقاطع مع مستطيل العنصر
- إذا كان هناك تداخل، تجربة الاتجاه المعاكس تلقائيا

---

### التفاصيل التقنية

#### الملف المعدل
| الملف | التغيير |
|-------|---------|
| `src/components/onboarding/OnboardingTour.tsx` | إعادة هيكلة التموضع + bottom-sheet للموبايل + تحسين hooks |

#### هيكل الكود الجديد (OnboardingTour.tsx)

**التغييرات الرئيسية:**

1. **الرندر المشروط حسب الجهاز:**

```text
على الموبايل:
  - البطاقة مثبتة في الأسفل (fixed bottom-0)
  - العرض الكامل مع حواف مدورة من الأعلى فقط
  - ارتفاع أقصى ~35% من الشاشة
  - العنصر المستهدف يتم تمريره لمنتصف الشاشة

على سطح المكتب:
  - البطاقة عائمة بجانب العنصر (النظام الحالي محسّن)
  - فحص تداخل إضافي
```

2. **Pre-Step Logic محسّن:**

```text
عند الانتقال لخطوة جديدة:
  1. إخفاء البطاقة
  2. التنقل للصفحة المطلوبة (إن لزم)
  3. التحقق من حالة القائمة الجانبية:
     - إذا requireSidebar && الجوال: فتح القائمة
     - إذا !requireSidebar && الجوال: إغلاق القائمة (إن كانت مفتوحة)
  4. التحقق من حالة السلة:
     - إذا requireCart && الجوال: فتح السلة
  5. انتظار 500ms
  6. scrollIntoView({ block: 'center' })
  7. انتظار 150ms
  8. حساب الموقع + إظهار البطاقة
```

3. **فحص التداخل (Desktop only):**

```text
بعد حساب الموقع:
  cardRect = { top, left, width: cw, height: ch }
  targetRect = { ... }
  
  إذا كان هناك تقاطع بين المستطيلين:
    -> تجربة الاتجاه المعاكس
    -> إذا فشل: تثبيت في الزاوية الأبعد عن العنصر
```

